<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="google-site-verification" content="true">








  <meta name="baidu-site-verification" content="true">







  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Java,Kotlin,coroutine,">





  <link rel="alternate" href="/atom.xml" title="A Big Boy Blog -  Tech Articls & Notes" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2">






<meta name="description" content="Basic PracticeFirst Example123456789101112import kotlinx.coroutines.*fun main() &amp;#123;     GlobalScope.launch &amp;#123; // launch a new coroutine in background and continue        delay(1000L)        pri">
<meta name="keywords" content="Java,Kotlin,coroutine">
<meta property="og:type" content="article">
<meta property="og:title" content="Kotlin coroutine">
<meta property="og:url" content="https://sulangsss.github.io/2019/07/07/Java/Kotlin/coroutine/index.html">
<meta property="og:site_name" content="A Big Boy Blog -  Tech Articls &amp; Notes">
<meta property="og:description" content="Basic PracticeFirst Example123456789101112import kotlinx.coroutines.*fun main() &amp;#123;     GlobalScope.launch &amp;#123; // launch a new coroutine in background and continue        delay(1000L)        pri">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-07-25T08:50:55.477Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kotlin coroutine">
<meta name="twitter:description" content="Basic PracticeFirst Example123456789101112import kotlinx.coroutines.*fun main() &amp;#123;     GlobalScope.launch &amp;#123; // launch a new coroutine in background and continue        delay(1000L)        pri">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.2',
    sidebar: {"position":"right","display":"always","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://sulangsss.github.io/2019/07/07/Java/Kotlin/coroutine/">





<meta name="baidu-site-verification" content="xV2vphJ53Q">


  <title>Kotlin coroutine | A Big Boy Blog -  Tech Articls & Notes</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?344f3e8f33d176fceb44e65d30a341dc";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">A Big Boy Blog -  Tech Articls & Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">Python Java Android Django Web -> sulang357159@gmail.com</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sulangsss.github.io/2019/07/07/Java/Kotlin/coroutine/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jason - sulang357159@163.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="A Big Boy Blog -  Tech Articls & Notes">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Kotlin coroutine</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-07T23:04:22+08:00">
                2019-07-07
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/Kotlin/" itemprop="url" rel="index">
                    <span itemprop="name">Kotlin</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="Basic-Practice"><a href="#Basic-Practice" class="headerlink" title="Basic Practice"></a>Basic Practice</h3><h4 id="First-Example"><a href="#First-Example" class="headerlink" title="First Example"></a>First Example</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"></span><br><span class="line"><span class="function">fun <span class="title">main</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    GlobalScope.launch &#123; <span class="comment">// launch a new coroutine in background and continue</span></span><br><span class="line">        delay(<span class="number">1000L</span>)</span><br><span class="line">        println(<span class="string">"World!"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    println(<span class="string">"Hello,"</span>) <span class="comment">// main thread continues here immediately</span></span><br><span class="line">    runBlocking &#123;     <span class="comment">// but this expression blocks the main thread</span></span><br><span class="line">        delay(<span class="number">2000L</span>)  <span class="comment">// ... while we delay for 2 seconds to keep JVM alive</span></span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"></span><br><span class="line"><span class="function">fun <span class="title">main</span><span class="params">()</span> </span>= runBlocking&lt;Unit&gt; &#123; <span class="comment">// start main coroutine</span></span><br><span class="line">    GlobalScope.launch &#123; <span class="comment">// launch a new coroutine in background and continue</span></span><br><span class="line">        delay(<span class="number">1000L</span>)</span><br><span class="line">        println(<span class="string">"World!"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    println(<span class="string">"Hello,"</span>) <span class="comment">// main coroutine continues here immediately</span></span><br><span class="line">    delay(<span class="number">2000L</span>)      <span class="comment">// delaying for 2 seconds to keep JVM alive</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  or</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function">fun <span class="title">test</span><span class="params">()</span> </span>= runBlocking &#123;</span><br><span class="line">    GlobalScope.launch &#123;</span><br><span class="line">        <span class="comment">// launch a new coroutine in background and continue</span></span><br><span class="line">        delay(<span class="number">1000L</span>)</span><br><span class="line">        println(<span class="string">"World!"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    println(<span class="string">"Hello,"</span>) <span class="comment">// main coroutine continues here immediately</span></span><br><span class="line">    delay(<span class="number">2000L</span>)      <span class="comment">// delaying for 2 seconds to keep JVM alive</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Structured-concurrency"><a href="#Structured-concurrency" class="headerlink" title="Structured concurrency"></a>Structured concurrency</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"></span><br><span class="line"><span class="function">fun <span class="title">main</span><span class="params">()</span> </span>= runBlocking &#123; <span class="comment">// this: CoroutineScope</span></span><br><span class="line">    launch &#123; <span class="comment">// launch a new coroutine in the scope of runBlocking</span></span><br><span class="line">        delay(<span class="number">1000L</span>)</span><br><span class="line">        println(<span class="string">"World!"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    println(<span class="string">"Hello,"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Scope-builder"><a href="#Scope-builder" class="headerlink" title="Scope builder"></a>Scope builder</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"></span><br><span class="line"><span class="function">fun <span class="title">main</span><span class="params">()</span> </span>= runBlocking &#123; <span class="comment">// this: CoroutineScope</span></span><br><span class="line">    launch &#123; </span><br><span class="line">        delay(<span class="number">200L</span>)</span><br><span class="line">        println(<span class="string">"Task from runBlocking"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    coroutineScope &#123; <span class="comment">// Creates a coroutine scope</span></span><br><span class="line">        launch &#123;</span><br><span class="line">            delay(<span class="number">500L</span>) </span><br><span class="line">            println(<span class="string">"Task from nested launch"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        delay(<span class="number">100L</span>)</span><br><span class="line">        println(<span class="string">"Task from coroutine scope"</span>) <span class="comment">// This line will be printed before the nested launch</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    println(<span class="string">"Coroutine scope is over"</span>) <span class="comment">// This line is not printed until the nested launch completes</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="suspending-function"><a href="#suspending-function" class="headerlink" title="suspending function"></a>suspending function</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"></span><br><span class="line"><span class="function">fun <span class="title">main</span><span class="params">()</span> </span>= runBlocking &#123;</span><br><span class="line">    launch &#123; doWorld() &#125;</span><br><span class="line">    println(<span class="string">"Hello,"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// this is your first suspending function</span></span><br><span class="line"><span class="function">suspend fun <span class="title">doWorld</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    delay(<span class="number">1000L</span>)</span><br><span class="line">    println(<span class="string">"World!"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="repeat"><a href="#repeat" class="headerlink" title="repeat"></a>repeat</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"></span><br><span class="line"><span class="function">fun <span class="title">main</span><span class="params">()</span> </span>= runBlocking &#123;</span><br><span class="line">    repeat(<span class="number">100_000</span>) &#123; <span class="comment">// launch a lot of coroutines</span></span><br><span class="line">        launch &#123;</span><br><span class="line">            delay(<span class="number">1000L</span>)</span><br><span class="line">            print(<span class="string">"."</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It launches 100K coroutines and, after a second, each coroutine prints a dot. Now, try that with threads. What would happen? (Most likely your code will produce some sort of out-of-memory error)</p>
<hr>
<h3 id="Cancellation"><a href="#Cancellation" class="headerlink" title="Cancellation"></a>Cancellation</h3><h4 id="Cancelling-coroutine-execution"><a href="#Cancelling-coroutine-execution" class="headerlink" title="Cancelling coroutine execution"></a>Cancelling coroutine execution</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">val job = launch &#123;</span><br><span class="line">    repeat(<span class="number">1000</span>) &#123; i -&gt;</span><br><span class="line">        println(<span class="string">"job: I'm sleeping $i ..."</span>)</span><br><span class="line">        delay(<span class="number">500L</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">delay(<span class="number">1300L</span>) <span class="comment">// delay a bit</span></span><br><span class="line">println(<span class="string">"main: I'm tired of waiting!"</span>)</span><br><span class="line">job.cancel() <span class="comment">// cancels the job</span></span><br><span class="line">job.join() <span class="comment">// waits for job's completion </span></span><br><span class="line">println(<span class="string">"main: Now I can quit."</span>)</span><br></pre></td></tr></table></figure>
<h4 id="withTimeout"><a href="#withTimeout" class="headerlink" title="withTimeout"></a>withTimeout</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">withTimeout(<span class="number">1300L</span>) &#123;</span><br><span class="line">    repeat(<span class="number">1000</span>) &#123; i -&gt;</span><br><span class="line">            println(<span class="string">"I'm sleeping $i ..."</span>)</span><br><span class="line">        delay(<span class="number">500L</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="withTimeoutOrNull"><a href="#withTimeoutOrNull" class="headerlink" title="withTimeoutOrNull"></a>withTimeoutOrNull</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function">fun <span class="title">test</span><span class="params">()</span> </span>= runBlocking &#123;</span><br><span class="line">    val result = withTimeoutOrNull(<span class="number">1300L</span>) &#123;</span><br><span class="line">        repeat(<span class="number">1000</span>) &#123; i -&gt;</span><br><span class="line">            println(<span class="string">"I'm sleeping $i ..."</span>)</span><br><span class="line">            delay(<span class="number">500L</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">"Done"</span> <span class="comment">// will get cancelled before it produces this result</span></span><br><span class="line">    &#125;</span><br><span class="line">    println(<span class="string">"Result is $result"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// I'm sleeping 0 ...</span></span><br><span class="line"><span class="comment">// I'm sleeping 1 ...</span></span><br><span class="line"><span class="comment">// I'm sleeping 2 ...</span></span><br><span class="line"><span class="comment">// Result is null</span></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="Channels"><a href="#Channels" class="headerlink" title="Channels"></a>Channels</h3><p>Channels provide a way to transfer a stream of values.</p>
<p>A Channel is conceptually very similar to BlockingQueue. One key difference is that instead of a blocking put operation it has a suspending send, and instead of a blocking take operation it has a suspending receive.</p>
<h4 id="send-number-by-channels"><a href="#send-number-by-channels" class="headerlink" title="send number by channels"></a>send number by channels</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function">fun <span class="title">test</span><span class="params">()</span> </span>= runBlocking &#123;</span><br><span class="line">    val channel = Channel&lt;Int&gt;()</span><br><span class="line">    launch &#123;</span><br><span class="line">        <span class="comment">// this might be heavy CPU-consuming computation or async logic, we'll just send five squares</span></span><br><span class="line">        <span class="keyword">for</span> (x in <span class="number">1</span>..<span class="number">5</span>) channel.send(x * x)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// here we print five received integers:</span></span><br><span class="line">    repeat(<span class="number">5</span>) &#123; println(channel.receive()) &#125;</span><br><span class="line">    println(<span class="string">"Done!"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Closing-and-iteration-over-channels"><a href="#Closing-and-iteration-over-channels" class="headerlink" title="Closing and iteration over channels"></a>Closing and iteration over channels</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">val channel = Channel&lt;Int&gt;()</span><br><span class="line">launch &#123;</span><br><span class="line">    <span class="keyword">for</span> (x in <span class="number">1</span>..<span class="number">5</span>) channel.send(x * x)</span><br><span class="line">    channel.close() <span class="comment">// we're done sending</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// here we print received values using `for` loop (until the channel is closed)</span></span><br><span class="line"><span class="keyword">for</span> (y in channel) println(y)</span><br><span class="line">println(<span class="string">"Done!"</span>)</span><br></pre></td></tr></table></figure>
<h4 id="channel-producers"><a href="#channel-producers" class="headerlink" title="channel producers"></a>channel producers</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> kotlinx.coroutines.guide.channel03</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.*</span><br><span class="line"><span class="keyword">import</span> kotlinx.coroutines.channels.*</span><br><span class="line"></span><br><span class="line">fun CoroutineScope.produceSquares(): ReceiveChannel&lt;Int&gt; = produce &#123;</span><br><span class="line">    <span class="keyword">for</span> (x in <span class="number">1</span>..<span class="number">5</span>) send(x * x)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">fun <span class="title">main</span><span class="params">()</span> </span>= runBlocking &#123;</span><br><span class="line">    <span class="comment">//sampleStart</span></span><br><span class="line">    val squares = produceSquares()</span><br><span class="line">    squares.consumeEach &#123; println(it) &#125;</span><br><span class="line">    println(<span class="string">"Done!"</span>)</span><br><span class="line">    <span class="comment">//sampleEnd</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Fan-out"><a href="#Fan-out" class="headerlink" title="Fan-out"></a>Fan-out</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">fun CoroutineScope.produceNumbers() = produce&lt;Int&gt; &#123;</span><br><span class="line">        var x = <span class="number">1</span> <span class="comment">// start from 1</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            send(x++) <span class="comment">// produce next</span></span><br><span class="line">            delay(<span class="number">100</span>) <span class="comment">// wait 0.1s</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">fun CoroutineScope.launchProcessor(id: Int, channel: ReceiveChannel&lt;Int&gt;) = launch &#123;</span><br><span class="line">    <span class="keyword">for</span> (msg in channel) &#123;</span><br><span class="line">        println(<span class="string">"Processor #$id received $msg"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function">fun <span class="title">test</span><span class="params">()</span> </span>= runBlocking &#123;</span><br><span class="line">    val producer = produceNumbers()</span><br><span class="line">    repeat(<span class="number">5</span>) &#123; launchProcessor(it, producer) &#125;</span><br><span class="line">    delay(<span class="number">950</span>)</span><br><span class="line">    producer.cancel() <span class="comment">// cancel producer coroutine and thus kill them all</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Processor #0 received 1</span><br><span class="line">Processor #0 received 2</span><br><span class="line">Processor #1 received 3</span><br><span class="line">Processor #2 received 4</span><br><span class="line">Processor #3 received 5</span><br><span class="line">Processor #4 received 6</span><br><span class="line">Processor #0 received 7</span><br><span class="line">Processor #1 received 8</span><br><span class="line">Processor #2 received 9</span><br><span class="line">Processor #3 received 10</span><br></pre></td></tr></table></figure>
<h4 id="Fan-in"><a href="#Fan-in" class="headerlink" title="Fan-in"></a>Fan-in</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">suspend fun <span class="title">sendString</span><span class="params">(channel: SendChannel&lt;String&gt;, s: String, time: Long)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            delay(time)</span><br><span class="line">            channel.send(s)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function">fun <span class="title">test</span><span class="params">()</span> </span>= runBlocking &#123;</span><br><span class="line">    val channel = Channel&lt;String&gt;()</span><br><span class="line">    launch &#123; sendString(channel, <span class="string">"foo"</span>, <span class="number">200L</span>) &#125;</span><br><span class="line">    launch &#123; sendString(channel, <span class="string">"BAR!"</span>, <span class="number">500L</span>) &#125;</span><br><span class="line">    repeat(<span class="number">6</span>) &#123; <span class="comment">// receive first six</span></span><br><span class="line">        println(channel.receive())</span><br><span class="line">    &#125;</span><br><span class="line">    coroutineContext.cancelChildren() <span class="comment">// cancel all children to let main finish</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">foo</span><br><span class="line">foo</span><br><span class="line">BAR!</span><br><span class="line">foo</span><br><span class="line">foo</span><br><span class="line">BAR!</span><br></pre></td></tr></table></figure>
<h4 id="Buffered-channels"><a href="#Buffered-channels" class="headerlink" title="Buffered channels"></a>Buffered channels</h4><p> If send is invoked first, then it is suspended until receive is invoked, if receive is invoked first, it is suspended until send is invoked.</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function">fun <span class="title">test</span><span class="params">()</span> </span>= runBlocking &#123;</span><br><span class="line">    val channel = Channel&lt;Int&gt;(<span class="number">4</span>) <span class="comment">// create buffered channel</span></span><br><span class="line">    val sender = launch &#123;</span><br><span class="line">        <span class="comment">// launch sender coroutine</span></span><br><span class="line">        repeat(<span class="number">10</span>) &#123;</span><br><span class="line">            println(<span class="string">"Sending $it"</span>) <span class="comment">// print before sending each element</span></span><br><span class="line">            channel.send(it) <span class="comment">// will suspend when buffer is full</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// don't receive anything... just wait....</span></span><br><span class="line">    delay(<span class="number">1000</span>)</span><br><span class="line">    println(<span class="string">"done, then to cancel"</span>)</span><br><span class="line">    sender.cancel() <span class="comment">// cancel sender coroutine</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Channels-are-fair"><a href="#Channels-are-fair" class="headerlink" title="Channels are fair"></a>Channels are fair</h4> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function">data class <span class="title">Ball</span><span class="params">(var hits: Int)</span></span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function">@Test</span></span><br><span class="line"><span class="function">fun <span class="title">test</span><span class="params">()</span> </span>= runBlocking &#123;</span><br><span class="line">    val table = Channel&lt;Ball&gt;() <span class="comment">// a shared table</span></span><br><span class="line">    launch &#123; player(<span class="string">"ping"</span>, table) &#125;</span><br><span class="line">    launch &#123; player(<span class="string">"pong"</span>, table) &#125;</span><br><span class="line">    table.send(Ball(<span class="number">0</span>)) <span class="comment">// serve the ball</span></span><br><span class="line">    delay(<span class="number">1000</span>) <span class="comment">// delay 1 second</span></span><br><span class="line">    coroutineContext.cancelChildren() <span class="comment">// game over, cancel them</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">suspend fun <span class="title">player</span><span class="params">(name: String, table: Channel&lt;Ball&gt;)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (ball in table) &#123; <span class="comment">// receive the ball in a loop</span></span><br><span class="line">        ball.hits++</span><br><span class="line">        println(<span class="string">"$name $ball"</span>)</span><br><span class="line">        delay(<span class="number">300</span>) <span class="comment">// wait a bit</span></span><br><span class="line">        table.send(ball) <span class="comment">// send the ball back</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ping Ball(hits=1)</span><br><span class="line">pong Ball(hits=2)</span><br><span class="line">ping Ball(hits=3)</span><br><span class="line">pong Ball(hits=4)</span><br></pre></td></tr></table></figure>
<h4 id="Ticker-channels"><a href="#Ticker-channels" class="headerlink" title="Ticker channels"></a>Ticker channels</h4><p> Ticker channel is a special rendezvous channel that produces Unit every time given delay passes since last consumption from this channel. </p>
<p> Though it may seem to be useless standalone, it is a useful building block to create complex time-based produce pipelines and operators that do windowing and other time-dependent processing. </p>
<p> Ticker channel can be used in select to perform “on tick” action.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function">fun <span class="title">test</span><span class="params">()</span> </span>= runBlocking &#123;</span><br><span class="line">    val tickerChannel = ticker(delayMillis = <span class="number">100</span>, initialDelayMillis = <span class="number">0</span>) <span class="comment">// create ticker channel</span></span><br><span class="line">    var nextElement = withTimeoutOrNull(<span class="number">1</span>) &#123; tickerChannel.receive() &#125;</span><br><span class="line">    println(<span class="string">"Initial element is available immediately: $nextElement"</span>) <span class="comment">// initial delay hasn't passed yet</span></span><br><span class="line"></span><br><span class="line">    nextElement = withTimeoutOrNull(<span class="number">50</span>) &#123; tickerChannel.receive() &#125; <span class="comment">// all subsequent elements has 100ms delay</span></span><br><span class="line">    println(<span class="string">"Next element is not ready in 50 ms: $nextElement"</span>)</span><br><span class="line"></span><br><span class="line">    nextElement = withTimeoutOrNull(<span class="number">60</span>) &#123; tickerChannel.receive() &#125;</span><br><span class="line">    println(<span class="string">"Next element is ready in 100 ms: $nextElement"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Emulate large consumption delays</span></span><br><span class="line">    println(<span class="string">"Consumer pauses for 150ms"</span>)</span><br><span class="line">    delay(<span class="number">150</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Next element is available immediately</span></span><br><span class="line">    nextElement = withTimeoutOrNull(<span class="number">1</span>) &#123; tickerChannel.receive() &#125;</span><br><span class="line">    println(<span class="string">"Next element is available immediately after large consumer delay: $nextElement"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note that the pause between `receive` calls is taken into account and next element arrives faster</span></span><br><span class="line">    nextElement = withTimeoutOrNull(<span class="number">60</span>) &#123; tickerChannel.receive() &#125;</span><br><span class="line">    println(<span class="string">"Next element is ready in 50ms after consumer pause in 150ms: $nextElement"</span>)</span><br><span class="line"></span><br><span class="line">    tickerChannel.cancel() <span class="comment">// indicate that no more elements are needed</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Initial element is available immediately: kotlin.Unit</span><br><span class="line">Next element is not ready in 50 ms: null</span><br><span class="line">Next element is ready in 100 ms: kotlin.Unit</span><br><span class="line">Consumer pauses for 150ms</span><br><span class="line">Next element is available immediately after large consumer delay: kotlin.Unit</span><br><span class="line">Next element is ready in 50ms after consumer pause in 150ms: kotlin.Unit</span><br></pre></td></tr></table></figure>
<h3 id="Composing-suspending-functions"><a href="#Composing-suspending-functions" class="headerlink" title="Composing suspending functions"></a>Composing suspending functions</h3><h4 id="Sequential"><a href="#Sequential" class="headerlink" title="Sequential"></a>Sequential</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">suspend fun <span class="title">doSomethingUsefulOne</span><span class="params">()</span>: Int </span>&#123;</span><br><span class="line">    delay(<span class="number">1000L</span>) <span class="comment">// pretend we are doing something useful here</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">13</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">suspend fun <span class="title">doSomethingUsefulTwo</span><span class="params">()</span>: Int </span>&#123;</span><br><span class="line">    delay(<span class="number">1000L</span>) <span class="comment">// pretend we are doing something useful here, too</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">29</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">val time = measureTimeMillis &#123;</span><br><span class="line">    val one = doSomethingUsefulOne()</span><br><span class="line">    val two = doSomethingUsefulTwo()</span><br><span class="line">    println(<span class="string">"The answer is $&#123;one + two&#125;"</span>)</span><br><span class="line">&#125;</span><br><span class="line">println(<span class="string">"Completed in $time ms"</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The answer is 42</span><br><span class="line">Completed in 2013 ms</span><br></pre></td></tr></table></figure>
<h4 id="async"><a href="#async" class="headerlink" title="async"></a>async</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">val time = measureTimeMillis &#123;</span><br><span class="line">    val one = async &#123; doSomethingUsefulOne() &#125;</span><br><span class="line">    val two = async &#123; doSomethingUsefulTwo() &#125;</span><br><span class="line">    println(<span class="string">"The answer is $&#123;one.await() + two.await()&#125;"</span>)</span><br><span class="line">&#125;</span><br><span class="line">println(<span class="string">"Completed in $time ms"</span>)</span><br></pre></td></tr></table></figure>
<h4 id="Lazily-started-async"><a href="#Lazily-started-async" class="headerlink" title="Lazily started async"></a>Lazily started async</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">val time = measureTimeMillis &#123;</span><br><span class="line">    val one = async(start = CoroutineStart.LAZY) &#123; doSomethingUsefulOne() &#125;</span><br><span class="line">    val two = async(start = CoroutineStart.LAZY) &#123; doSomethingUsefulTwo() &#125;</span><br><span class="line">    <span class="comment">// some computation</span></span><br><span class="line">    one.start() <span class="comment">// start the first one</span></span><br><span class="line">    two.start() <span class="comment">// start the second one</span></span><br><span class="line">    println(<span class="string">"The answer is $&#123;one.await() + two.await()&#125;"</span>)</span><br><span class="line">&#125;</span><br><span class="line">println(<span class="string">"Completed in $time ms"</span>)</span><br></pre></td></tr></table></figure>
<h4 id="Async-style-functions"><a href="#Async-style-functions" class="headerlink" title="Async-style functions"></a>Async-style functions</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The result type of somethingUsefulOneAsync is Deferred&lt;Int&gt;</span></span><br><span class="line"><span class="function">fun <span class="title">somethingUsefulOneAsync</span><span class="params">()</span> </span>= GlobalScope.async &#123;</span><br><span class="line">    doSomethingUsefulOne()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The result type of somethingUsefulTwoAsync is Deferred&lt;Int&gt;</span></span><br><span class="line"><span class="function">fun <span class="title">somethingUsefulTwoAsync</span><span class="params">()</span> </span>= GlobalScope.async &#123;</span><br><span class="line">    doSomethingUsefulTwo()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">fun <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    val time = measureTimeMillis &#123;</span><br><span class="line">        <span class="comment">// we can initiate async actions outside of a coroutine</span></span><br><span class="line">        val one = somethingUsefulOneAsync()</span><br><span class="line">        val two = somethingUsefulTwoAsync()</span><br><span class="line">        <span class="comment">// but waiting for a result must involve either suspending or blocking.</span></span><br><span class="line">        <span class="comment">// here we use `runBlocking &#123; ... &#125;` to block the main thread while waiting for the result</span></span><br><span class="line">        runBlocking &#123;</span><br><span class="line">            println(<span class="string">"The answer is $&#123;one.await() + two.await()&#125;"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    println(<span class="string">"Completed in $time ms"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="Coroutine-context-and-dispatchers"><a href="#Coroutine-context-and-dispatchers" class="headerlink" title="Coroutine context and dispatchers"></a>Coroutine context and dispatchers</h3><ul>
<li>Dispatchers and threads: Coroutine context includes a coroutine dispatcher that determines what thread or threads the corresponding coroutine uses for its execution. Coroutine dispatcher can confine coroutine execution to a specific thread, dispatch it to a thread pool, or let it run unconfined.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">launch &#123; <span class="comment">// context of the parent, main runBlocking coroutine</span></span><br><span class="line">    println(<span class="string">"main runBlocking      : I'm working in thread $&#123;Thread.currentThread().name&#125;"</span>)</span><br><span class="line">&#125;</span><br><span class="line">launch(Dispatchers.Unconfined) &#123; <span class="comment">// not confined -- will work with main thread</span></span><br><span class="line">    println(<span class="string">"Unconfined            : I'm working in thread $&#123;Thread.currentThread().name&#125;"</span>)</span><br><span class="line">&#125;</span><br><span class="line">launch(Dispatchers.Default) &#123; <span class="comment">// will get dispatched to DefaultDispatcher </span></span><br><span class="line">    println(<span class="string">"Default               : I'm working in thread $&#123;Thread.currentThread().name&#125;"</span>)</span><br><span class="line">&#125;</span><br><span class="line">launch(newSingleThreadContext(<span class="string">"MyOwnThread"</span>)) &#123; <span class="comment">// will get its own new thread</span></span><br><span class="line">    println(<span class="string">"newSingleThreadContext: I'm working in thread $&#123;Thread.currentThread().name&#125;"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Unconfined            : I'm working in thread main @coroutine#3</span><br><span class="line">Default               : I'm working in thread DefaultDispatcher-worker-1 @coroutine#4</span><br><span class="line">main runBlocking      : I'm working in thread main @coroutine#2</span><br><span class="line">newSingleThreadContext: I'm working in thread MyOwnThread @coroutine#5</span><br></pre></td></tr></table></figure>
<p>When launch { … } is used without parameters, it inherits the context (and thus dispatcher) from the CoroutineScope that it is being launched from. In this case, it inherits the context of the main runBlocking coroutine which runs in the main thread.</p>
<ol>
<li><p>Dispatchers.Unconfined is a special dispatcher that also appears to run in the main thread, but it is, in fact, a different mechanism that is explained later.</p>
</li>
<li><p>The default dispatcher, that is used when coroutines are launched in GlobalScope, is represented by Dispatchers.Default and uses shared background pool of threads, so launch(Dispatchers.Default) { … } uses the same dispatcher as GlobalScope.launch { … }.</p>
</li>
<li><p>newSingleThreadContext creates a thread for the coroutine to run. A dedicated thread is a very expensive resource. In a real application it must be either released, when no longer needed, using close function, or stored in a top-level variable and reused throughout the application.</p>
</li>
</ol>
<h4 id="Unconfined-vs-confined-dispatcher"><a href="#Unconfined-vs-confined-dispatcher" class="headerlink" title="Unconfined vs confined dispatcher"></a>Unconfined vs confined dispatcher</h4><p>The Dispatchers.Unconfined coroutine dispatcher starts coroutine in the caller thread, but only until the first suspension point. After suspension it resumes in the thread that is fully determined by the suspending function that was invoked. Unconfined dispatcher is appropriate when coroutine does not consume CPU time nor updates any shared data (like UI) that is confined to a specific thread.</p>
<p>On the other side, by default, a dispatcher for the outer CoroutineScope is inherited. The default dispatcher for runBlocking coroutine, in particular, is confined to the invoker thread, so inheriting it has the effect of confining execution to this thread with a predictable FIFO scheduling.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function">fun <span class="title">test</span><span class="params">()</span> </span>= runBlocking &#123;</span><br><span class="line">    <span class="comment">//sampleStart</span></span><br><span class="line">    launch(Dispatchers.Unconfined) &#123;</span><br><span class="line">        <span class="comment">// not confined -- will work with main thread</span></span><br><span class="line">        println(<span class="string">"Unconfined      : I'm working in thread $&#123;Thread.currentThread().name&#125;"</span>)</span><br><span class="line">        delay(<span class="number">500</span>)</span><br><span class="line">        println(<span class="string">"Unconfined      : After delay in thread $&#123;Thread.currentThread().name&#125;"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    launch &#123;</span><br><span class="line">        <span class="comment">// context of the parent, main runBlocking coroutine</span></span><br><span class="line">        println(<span class="string">"main runBlocking: I'm working in thread $&#123;Thread.currentThread().name&#125;"</span>)</span><br><span class="line">        delay(<span class="number">1000</span>)</span><br><span class="line">        println(<span class="string">"main runBlocking: After delay in thread $&#123;Thread.currentThread().name&#125;"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//sampleEnd</span></span><br><span class="line">    delay(<span class="number">2000</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Unconfined      : I'm working in thread main @coroutine#2</span><br><span class="line">main runBlocking: I'm working in thread main @coroutine#3</span><br><span class="line">Unconfined      : After delay in thread kotlinx.coroutines.DefaultExecutor @coroutine#2</span><br><span class="line">main runBlocking: After delay in thread main @coroutine#3</span><br></pre></td></tr></table></figure>
<h4 id="Debugging-coroutines-and-threads"><a href="#Debugging-coroutines-and-threads" class="headerlink" title="Debugging coroutines and threads"></a>Debugging coroutines and threads</h4><hr>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a href="https://kotlinlang.org/docs/reference/coroutines/basics.html" target="_blank" rel="noopener">https://kotlinlang.org/docs/reference/coroutines/basics.html</a></li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Java/" rel="tag"># Java</a>
          
            <a href="/tags/Kotlin/" rel="tag"># Kotlin</a>
          
            <a href="/tags/coroutine/" rel="tag"># coroutine</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/07/06/Java/Rx/Rx-Quick-Start/" rel="next" title="RxJava Quick Start">
                <i class="fa fa-chevron-left"></i> RxJava Quick Start
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/07/13/Java/Date/" rel="prev" title="Java Date">
                Java Date <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="Jason - sulang357159@163.com">
          
            <p class="site-author-name" itemprop="name">Jason - sulang357159@163.com</p>
            <p class="site-description motion-element" itemprop="description"></p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">597</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">252</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">651</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Basic-Practice"><span class="nav-number">1.</span> <span class="nav-text">Basic Practice</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#First-Example"><span class="nav-number">1.1.</span> <span class="nav-text">First Example</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Structured-concurrency"><span class="nav-number">1.2.</span> <span class="nav-text">Structured concurrency</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Scope-builder"><span class="nav-number">1.3.</span> <span class="nav-text">Scope builder</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#suspending-function"><span class="nav-number">1.4.</span> <span class="nav-text">suspending function</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#repeat"><span class="nav-number">1.5.</span> <span class="nav-text">repeat</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Cancellation"><span class="nav-number">2.</span> <span class="nav-text">Cancellation</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Cancelling-coroutine-execution"><span class="nav-number">2.1.</span> <span class="nav-text">Cancelling coroutine execution</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#withTimeout"><span class="nav-number">2.2.</span> <span class="nav-text">withTimeout</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#withTimeoutOrNull"><span class="nav-number">2.3.</span> <span class="nav-text">withTimeoutOrNull</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Channels"><span class="nav-number">3.</span> <span class="nav-text">Channels</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#send-number-by-channels"><span class="nav-number">3.1.</span> <span class="nav-text">send number by channels</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Closing-and-iteration-over-channels"><span class="nav-number">3.2.</span> <span class="nav-text">Closing and iteration over channels</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#channel-producers"><span class="nav-number">3.3.</span> <span class="nav-text">channel producers</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Fan-out"><span class="nav-number">3.4.</span> <span class="nav-text">Fan-out</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Fan-in"><span class="nav-number">3.5.</span> <span class="nav-text">Fan-in</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Buffered-channels"><span class="nav-number">3.6.</span> <span class="nav-text">Buffered channels</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Channels-are-fair"><span class="nav-number">3.7.</span> <span class="nav-text">Channels are fair</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Ticker-channels"><span class="nav-number">3.8.</span> <span class="nav-text">Ticker channels</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Composing-suspending-functions"><span class="nav-number">4.</span> <span class="nav-text">Composing suspending functions</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Sequential"><span class="nav-number">4.1.</span> <span class="nav-text">Sequential</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#async"><span class="nav-number">4.2.</span> <span class="nav-text">async</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Lazily-started-async"><span class="nav-number">4.3.</span> <span class="nav-text">Lazily started async</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Async-style-functions"><span class="nav-number">4.4.</span> <span class="nav-text">Async-style functions</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Coroutine-context-and-dispatchers"><span class="nav-number">5.</span> <span class="nav-text">Coroutine context and dispatchers</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Unconfined-vs-confined-dispatcher"><span class="nav-number">5.1.</span> <span class="nav-text">Unconfined vs confined dispatcher</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Debugging-coroutines-and-threads"><span class="nav-number">5.2.</span> <span class="nav-text">Debugging coroutines and threads</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reference"><span class="nav-number">6.</span> <span class="nav-text">Reference</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jason - sulang357159@163.com</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  

  

</body>
</html>
