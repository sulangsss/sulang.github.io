<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>A Big Boy Blog -  Tech Articls &amp; Notes</title>
  
  <subtitle>Python Java Android Django Web -&gt; sulang357159@gmail.com</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://sulangsss.github.io/"/>
  <updated>2019-03-27T13:43:01.299Z</updated>
  <id>https://sulangsss.github.io/</id>
  
  <author>
    <name>Jason - sulang357159@163.com</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>GCP Builder</title>
    <link href="https://sulangsss.github.io/2019/03/27/Kubenetes/GCP/Builder/"/>
    <id>https://sulangsss.github.io/2019/03/27/Kubenetes/GCP/Builder/</id>
    <published>2019-03-27T10:00:06.000Z</published>
    <updated>2019-03-27T13:43:01.299Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Custom-Building-Machine"><a href="#Custom-Building-Machine" class="headerlink" title="Custom Building Machine"></a>Custom Building Machine</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># view machine on region</span></span><br><span class="line">gcloud compute machine-types list | grep asia-east1</span><br><span class="line"></span><br><span class="line"><span class="comment"># build</span></span><br><span class="line">kbuild cloudbuild-dev.yaml --machine-type=n1-highcpu-8 .</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://cloud.google.com/compute/docs/machine-types?hl=zh-cn" target="_blank" rel="noopener">https://cloud.google.com/compute/docs/machine-types?hl=zh-cn</a><br><a href="https://cloud.google.com/cloud-build/docs/build-config" target="_blank" rel="noopener">https://cloud.google.com/cloud-build/docs/build-config</a><br><a href="https://docs.docker.com/engine/reference/run/" target="_blank" rel="noopener">https://docs.docker.com/engine/reference/run/</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Custom-Building-Machine&quot;&gt;&lt;a href=&quot;#Custom-Building-Machine&quot; class=&quot;headerlink&quot; title=&quot;Custom Building Machine&quot;&gt;&lt;/a&gt;Custom Building M
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://sulangsss.github.io/categories/Kubernetes/"/>
    
      <category term="GCP" scheme="https://sulangsss.github.io/categories/Kubernetes/GCP/"/>
    
    
      <category term="GCP" scheme="https://sulangsss.github.io/tags/GCP/"/>
    
      <category term="Builder" scheme="https://sulangsss.github.io/tags/Builder/"/>
    
  </entry>
  
  <entry>
    <title>Grafana Configuration</title>
    <link href="https://sulangsss.github.io/2019/03/25/Grafana/Grafana-Configuration/"/>
    <id>https://sulangsss.github.io/2019/03/25/Grafana/Grafana-Configuration/</id>
    <published>2019-03-25T11:13:06.000Z</published>
    <updated>2019-03-25T11:30:52.813Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Kuberntes-Configuration"><a href="#Kuberntes-Configuration" class="headerlink" title="Kuberntes Configuration"></a>Kuberntes Configuration</h3><h4 id="GF-PATHS-DATA-’-var-lib-grafana’-is-not-writable"><a href="#GF-PATHS-DATA-’-var-lib-grafana’-is-not-writable" class="headerlink" title="GF_PATHS_DATA=’/var/lib/grafana’ is not writable"></a>GF_PATHS_DATA=’/var/lib/grafana’ is not writable</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">grafana-core</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">grafana-core</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  serviceName:</span> <span class="string">"grafana-core-headless-service"</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">grafana-core</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">grafana-core</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      initContainers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">grafana-chown</span></span><br><span class="line"><span class="attr">          command:</span> <span class="string">["chown",</span> <span class="string">"-R"</span><span class="string">,</span> <span class="string">"472:472"</span><span class="string">,</span> <span class="string">"/var/lib/grafana"</span><span class="string">]</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">          volumeMounts:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">grafana-core-pvc</span></span><br><span class="line"><span class="attr">              mountPath:</span> <span class="string">/var/lib/grafana</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">grafana-core</span></span><br><span class="line"><span class="attr">          image:</span> </span><br><span class="line"><span class="attr">          resources:</span></span><br><span class="line"><span class="attr">            requests:</span></span><br><span class="line"><span class="attr">              memory:</span> <span class="number">256</span><span class="string">M</span></span><br><span class="line"><span class="attr">            limits:</span></span><br><span class="line"><span class="attr">              memory:</span> <span class="number">1</span><span class="string">G</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">3000</span></span><br><span class="line"><span class="attr">          volumeMounts:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">grafana-core-pvc</span></span><br><span class="line"><span class="attr">              mountPath:</span> <span class="string">/var/lib/grafana</span></span><br><span class="line"><span class="attr">  volumeClaimTemplates:</span></span><br><span class="line"><span class="attr">    - metadata:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">grafana-core-pvc</span></span><br><span class="line"><span class="attr">      spec:</span></span><br><span class="line"><span class="attr">        accessModes:</span> <span class="string">[</span> <span class="string">"ReadWriteOnce"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">        storageClassName:</span> <span class="string">"pd-standard"</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            storage:</span> <span class="number">1</span><span class="string">Gi</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Kuberntes-Configuration&quot;&gt;&lt;a href=&quot;#Kuberntes-Configuration&quot; class=&quot;headerlink&quot; title=&quot;Kuberntes Configuration&quot;&gt;&lt;/a&gt;Kuberntes Configu
      
    
    </summary>
    
      <category term="Grafana" scheme="https://sulangsss.github.io/categories/Grafana/"/>
    
    
      <category term="Grafana" scheme="https://sulangsss.github.io/tags/Grafana/"/>
    
      <category term="Configuration" scheme="https://sulangsss.github.io/tags/Configuration/"/>
    
  </entry>
  
  <entry>
    <title>Helm Installation</title>
    <link href="https://sulangsss.github.io/2019/03/23/Kubenetes/Helm/HelmIn-stallation/"/>
    <id>https://sulangsss.github.io/2019/03/23/Kubenetes/Helm/HelmIn-stallation/</id>
    <published>2019-03-23T12:15:19.000Z</published>
    <updated>2019-03-26T12:17:22.844Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><h4 id="What-Is-Helm"><a href="#What-Is-Helm" class="headerlink" title="What Is Helm?"></a>What Is Helm?</h4><ul><li><strong>Helm</strong> is a Package Manager for Kubernetes.</li></ul><blockquote><p>NodeJS is to Kubernetes as NPM is to HELM!<br>Ruby is to Kubernetes as Gems are to HELM!<br>Swift is to Kubernetes as CocoaPods are to HELM!<br>Java is to Kubernetes as Maven is to HELM!</p></blockquote><ul><li><p>A <strong>Helm Chart</strong> is a Helm Package. This is the chart or “instructions” of how to put together your releasable package.</p></li><li><p><strong>Tiller</strong> is a server that runs inside your Kubernetes Cluster anytime you install Helm. Tiller manages installations of your Helm Charts. As Tiller installs containers into your Kubernetes Cluster on your behalf, security around this process should be a high priority for you.</p></li></ul><hr><h3 id="Installation-on-GKE"><a href="#Installation-on-GKE" class="headerlink" title="Installation on GKE"></a>Installation on GKE</h3><hr><h3 id="Command"><a href="#Command" class="headerlink" title="Command"></a>Command</h3><ul><li><p>helm install</p><blockquote><p>source from repository、tar、local and url<br>helm install stable/nginx<br>helm install ./nginx-1.2.3.tgz<br>helm install ./nginx<br>helm install <a href="https://example.com/charts/nginx-1.2.3.tgz" target="_blank" rel="noopener">https://example.com/charts/nginx-1.2.3.tgz</a></p></blockquote></li><li><p>helm search</p></li><li>helm ls</li><li>helm delete</li><li>helm rollback</li><li>helm repo update</li><li>helm status</li></ul><hr><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><blockquote><p><a href="https://medium.com/google-cloud/installing-helm-in-google-kubernetes-engine-7f07f43c536e" target="_blank" rel="noopener">https://medium.com/google-cloud/installing-helm-in-google-kubernetes-engine-7f07f43c536e</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Introduction&quot;&gt;&lt;a href=&quot;#Introduction&quot; class=&quot;headerlink&quot; title=&quot;Introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h3&gt;&lt;h4 id=&quot;What-Is-Helm&quot;&gt;&lt;a href=&quot;#W
      
    
    </summary>
    
      <category term="Kuberntes" scheme="https://sulangsss.github.io/categories/Kuberntes/"/>
    
      <category term="Helm" scheme="https://sulangsss.github.io/categories/Kuberntes/Helm/"/>
    
    
      <category term="Kuberntes" scheme="https://sulangsss.github.io/tags/Kuberntes/"/>
    
      <category term="Installation" scheme="https://sulangsss.github.io/tags/Installation/"/>
    
      <category term="Helm" scheme="https://sulangsss.github.io/tags/Helm/"/>
    
  </entry>
  
  <entry>
    <title>Technology Stack On Testing</title>
    <link href="https://sulangsss.github.io/2019/03/17/Testing/TechStack/"/>
    <id>https://sulangsss.github.io/2019/03/17/Testing/TechStack/</id>
    <published>2019-03-17T06:49:22.000Z</published>
    <updated>2019-03-24T12:58:05.000Z</updated>
    
    <content type="html"><![CDATA[<hr><h3 id="Performance-Metric"><a href="#Performance-Metric" class="headerlink" title="Performance Metric"></a>Performance Metric</h3><h4 id="业务指标"><a href="#业务指标" class="headerlink" title="业务指标"></a>业务指标</h4><ul><li><p>Response Time：业务响应时间，一般情况下，不同系统的业务响应时间期望值是不同的，１秒以内最佳；</p><ul><li><blockquote><p>平均响应时间：一段时间内响应时间的平均值。无法体现响应时间的波动情况。</p></blockquote></li><li><blockquote><p>中间响应时间：一段时间内响应时间的中间值，50%响应时间，有一半的服务器响应时间低于该值而另一半高于该值。</p></blockquote></li><li><blockquote><p>90%响应时间：一段时间内90%的事务响应时间比此数值要小。反应总体响应速度，和高于该值的10%超时率。是用来评估系统容量的重要指标之一。</p></blockquote></li><li><blockquote><p>最小响应时间：响应时间的最小值。反映服务最快处理能力。</p></blockquote></li><li><blockquote><p>最大响应时间：响应时间的最大值。反映服务器最慢处理能力。</p></blockquote></li></ul></li><li><p>Transaction Per Second(吞吐量)：业务处理能力，这个指标是衡量系统的处理能力的一个非常重要的指标，TPS可以参照同行业系统和结合具体业务，中小企业TPS值为50~1000笔/秒，银行TPS值为1000~50000笔/秒，淘宝TPS值为30000~300000笔/秒。</p><ul><li><blockquote><p>平均吞吐量：一段时间内吞吐量的平均值。无法体现吞吐量的瞬间变化。</p></blockquote></li><li><blockquote><p>峰值吞吐量：一段时间内吞吐量的最大值。是用来评估系统容量的重要指标之一。</p></blockquote></li><li><blockquote><p>最低吞吐量：一段时间内吞吐量的最小值。如果最小值接近0，说明系统有“卡”的现象。</p></blockquote></li><li><blockquote><p>70%的吞吐量集中区间：通过统计15%和85%的吞吐量边界值，计算出70%的吞吐量集中区间。区间越集中，吞吐量越稳定。</p></blockquote></li></ul></li><li><p>成功率：这个指标是衡量系统处于压力下，业务的成功率，一般业界成功率要大于99.6%。</p></li><li><p>Top Percentile(TP)：例如，TP90 = The tp90 is a minimum time under which 90% of requests have been served。</p><blockquote><p>TP50：指在一个时间段内（如5分钟），统计该方法每次调用所消耗的时间，并将这些时间按从小到大的顺序进行排序，取第50%的那个值作为TP50值；配置此监控指标对应的报警阀值后，需要保证在这个时间段内该方法所有调用的消耗时间至少有50%的值要小于此阀值，否则系统将会报警。<br>TP90，TP99，TP999与TP50值计算方式一致，它们分别代表着对方法的不同性能要求，TP50相对较低，TP90则比较高，TP99，TP999则对方法性能要求很高。<br>举例，假设现在有4次请求耗时分别为<br>10s，1000s，100s，2s<br>计算TP百分线的方法就是：</p><ol><li>先按升序排列 [2s, 10s, 100s, 1000s]</li><li>找到你需要用做统计的最后一个条目（向高取整）对应的数值，比如：TP50就是第 ceil(4<em>0.5)=2 个，即 10s ；TP90就是第 ceil(4</em>0.9)=4 个，即1000s。</li></ol></blockquote></li></ul><hr><h4 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h4><ul><li>Running：正在运行的进程。</li><li>Waiting：已准备就绪，等待运行的进程。</li><li>Blocked：因为等待某些事件完成而阻塞的进程，通常是在等待I/O，如Disk I/O，Network I/O等。</li></ul><p>这里的Running和Waiting共同构成Linux进程状态中的可运行状态(task_running)，而Blocked状态可以对应Linux进程状态中的不可中断睡眠状态(task_uninterruptible)。</p><p>Linux命令<strong>vmstat 1</strong>(1秒采集1次)可以读取相关状态数据，例如</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache      si   so    bi    bo   <span class="keyword">in</span>   cs    us  sy  id   wa st</span><br><span class="line"> 2  0     0   142064 374032 1951676    0    0     0     0    351  670    0  0   100   0  0</span><br></pre></td></tr></table></figure><ul><li>us：用户占用CPU的百分比</li><li>sy：系统(内核和中断)占用CPU的百分比</li><li>id：CPU空闲的百分比</li><li>r：表示运行队列(就是说多少个进程真的分配到CPU)，当这个值超过了CPU数目，就会出现CPU瓶颈了。</li><li>in：每秒CPU的中断次数，包括时间中断。</li><li>cs：秒上下文切换次数。</li><li>b：表示阻塞的进程。</li><li>si：每秒从磁盘读入虚拟内存的大小，如果这个值大于0，表示物理内存不够用或者内存泄露了，要查找耗内存进程解决掉。</li><li>so：每秒虚拟内存写入磁盘的大小，如果这个值大于0，同上。</li><li>bi：块设备每秒接收的块数量，这里的块设备是指系统上所有的磁盘和其他块设备，默认块大小是1024byte。</li><li>bo：块设备每秒发送的块数量，例如我们读取文件，bo就要大于0。</li><li>wt：等待IO</li></ul><p>性能测试指标中，CPU使用率通常用<strong>us + sy</strong>来计算，其可接受上限通常在70%~80%。另外需要注意的是，在测试过程中，如果sy的值长期大于25%，应该关注in(系统中断)和cs(上下文切换)的数值，并根据被测应用的实现逻辑来分析是否合理。</p><hr><ul><li><p>CPU Utilization Percentages(CPU使用率)：有进程处于Running状态的时间/总时间。</p><blockquote><p>在vmstat主要通过us、sys和id三列数据来体现。</p></blockquote></li><li><p>Processes on run queue(运行队列进程数)：Running状态 + Waiting状态的进程数，展示了正在运行和等待CPU资源的任务数，可以看作CPU的工作清单，是判断CPU资源是否成为瓶颈的重要依据。vmstat通过r的值来体现。</p><blockquote><p>如果r的值等于系统CPU总核数，则说明CPU已经满负荷。在负载测试中，其可接受上限通常不超过CPU核数的2倍。</p></blockquote></li><li><p>Context Switches(上下文切换)：简单来说，context指CPU寄存器和程序计数器在某时间点的内容，(进程)上下文切换即kernel挂起一个进程并将该进程此时的状态存储到内存，然后从内存中恢复下一个要执行的进程原来的状态到寄存器，从其上次暂停的执行代码开始继续执行至频繁的上下文切换将导致sy值增长。vmstat通过cs的值来体现</p></li><li><p>Load Average(平均负载)：在UNIX系统中，Load是对系统工作量的度量。Load取值有两种情况，多数UNIX系统取运行队列的值(vmstat输出的r)，而Linux系统取运行队列的值 + 处于task_uninterruptible状态的进程数(vmstat输出的b)，所以会出现CPU使用率不高但Load值很高的情况。</p><blockquote><p>Load Average就是在一段时间内的平均负载，系统工具top、uptime等提供1分钟、5分钟和15分钟的平均负载值。<br>top - 13:38:38 up 42 days,  3:25,  1 user,  load average: 0.80, 0.60, 0.53<br>当需要了解当前系统负载情况时，可以先查看Load average的值，如果系统持续处于高负载(如15分钟平均负载大于CPU总核数的两倍)，则查看vmstat的r值和b值来确认是CPU负荷重还是等待I/O的进程太多。</p></blockquote></li></ul><hr><h4 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h4><p>Memory资源也有三方面需要重点关注：<strong>Free Memory、Swap和Paging</strong>。</p><img src="/2019/03/17/Testing/TechStack/virtual-memory.jpg" title="进程状态"><p>物理内存和硬盘上的一块空间(SWAP)组合起来作为虚拟内存(Virtual Memory)为进程的运行提供一个连续的内存空间，这样的好处是进程可用的内存变大了，但需要注意的是，SWAP的读写速度远低于物理内存，并且物理内存和swap之间的数据交换会增加系统负担。</p><p>虚拟内存被分成页(x86系统默认页大小为4k)，内核读写虚拟内存以页为单位，当物理内存空间不足时，内存调度会将物理内存上不常使用的内存页数据存储到磁盘的SWAP空间，物理内存与swap空间之间的数据交换过程称为页面交换(Paging)。</p><ul><li><p>Free Memory(可用内存)：内存占用的直观数据，vmstat输出free的值，可用内存过小将影响整个系统的运行效率，对于稳定运行的系统，free可接受的范围通常应该大于物理内存的20%，即内存占用应该小于物理内存的80%。在压力测试时，系统内存资源的情况应该用可用内存结合页面交换情况来判断，如果可以内存很少，但页面交换也很少，此时可以认为内存资源还对系统性能构成严重影响。</p></li><li><p>Paging(页面交换)：页面交换包括从SWAP交换到内存和从内存交换到SWAP，如果系统出现频繁的页面交换，需要引起注意。可以从vmstat的si和so获取。</p><blockquote><p>si：每秒从SWAP读取到内存的数据大小；so：每秒从内存写入到SWAP的数据大小。</p></blockquote></li><li><p>Swap：可以从vmstat的swpd来获取当前SWAP空间的使用情况，应该和页面交换结合来分析，比如当swpd不为0，但si，so持续保持为0时，内存资源并没有成为系统的瓶颈。</p></li></ul><hr><h4 id="Disk"><a href="#Disk" class="headerlink" title="Disk"></a>Disk</h4><p>磁盘IO分为随机IO和顺序IO两种类型，在性能测试中应该先了解被测系统是偏向哪种类型。</p><ul><li>随机IO：随机读写数据，读写请求多，每次读写的数据量较小，其IO速度更依赖于磁盘每秒能IO次数(IOPS)。</li><li>顺序IO：顺序请求大量数据，读写请求个数相对较少，每次读写的数据量较大，顺序IO更重视每次IO的数据吞吐量。</li></ul><p>对于磁盘，首要关注使用率，IOPS和数据吞吐量，在Linux服务区，可以使用iostat来获取这些数据。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iostat -dxk 1</span><br><span class="line"><span class="comment"># -d 显示设备（磁盘）使用状态</span></span><br><span class="line"><span class="comment"># -k 某些使用block为单位的列强制使用Kilobytes为单位</span></span><br><span class="line"><span class="comment"># 1 表示刷新间隔为1秒</span></span><br><span class="line"></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># simple top-like I/O monitor</span></span><br><span class="line"><span class="comment"># apt install iotop</span></span><br><span class="line">iotop</span><br><span class="line">TID  PRIO  USER   DISK READ  DISK WRITE   SWAPIN   IO&gt;   COMMAND</span><br><span class="line"></span><br><span class="line"><span class="comment"># --version #显示版本号</span></span><br><span class="line"><span class="comment"># -h, --help #显示帮助信息</span></span><br><span class="line"><span class="comment"># -o, --only #显示进程或者线程实际上正在做的I/O，而不是全部的，可以随时切换按o</span></span><br><span class="line"><span class="comment"># -b, --batch #运行在非交互式的模式</span></span><br><span class="line"><span class="comment"># -n NUM, --iter=NUM #在非交互式模式下，设置显示的次数，</span></span><br><span class="line"><span class="comment"># -d SEC, --delay=SEC #设置显示的间隔秒数，支持非整数值</span></span><br><span class="line"><span class="comment"># -p PID, --pid=PID #只显示指定PID的信息</span></span><br><span class="line"><span class="comment"># -u USER, --user=USER #显示指定的用户的进程的信息</span></span><br><span class="line"><span class="comment"># -P, --processes #只显示进程，一般为显示所有的线程</span></span><br><span class="line"><span class="comment"># -a, --accumulated #显示从iotop启动后每个线程完成了的IO总数</span></span><br><span class="line"><span class="comment"># -k, --kilobytes #以千字节显示</span></span><br><span class="line"><span class="comment"># -t, --time #在每一行前添加一个当前的时间</span></span><br><span class="line"><span class="comment"># -q, --quiet #suppress some lines of header (implies --batch). This option can be specified up to three times to remove header lines.</span></span><br><span class="line"><span class="comment"># -q column names are only printed on the first iteration,</span></span><br><span class="line"><span class="comment"># -qq column names are never printed,</span></span><br><span class="line"><span class="comment"># -qqq the I/O summary is never printed.</span></span><br><span class="line"><span class="comment"># https://www.cnblogs.com/legendbaby/p/5056967.html</span></span><br></pre></td></tr></table></figure><p><strong>重点性能指标</strong></p><ul><li><p>%util：在统计时间内，所有处理IO时间除以总共统计时间。</p><blockquote><p>例如如果统计间隔1秒，该设备有0.8秒在处理IO，而0.2秒闲置，那么该设备的%util = 0.8/1 = 80%，所以该参数暗示了设备的繁忙程度。<br>一般地，如果该参数是100%表示设备已经接近满负荷运行了（当然如果是多磁盘，即使%util是100%，因为磁盘的并发能力，所以磁盘使用未必就到了瓶颈）。</p></blockquote></li><li><p>await：每一个IO请求的处理的平均时间（单位是微秒毫秒）。这里可以理解为IO的响应时间，一般地系统IO响应时间应该低于5ms，如果大于10ms就比较大了。</p><blockquote><p>这个时间包括了队列时间和服务时间，也就是说，一般情况下，await大于svctm，它们的差值越小，则说明队列时间越短，反之差值越大，队列时间越长，说明系统出了问题。</p></blockquote></li><li>svctm：表示平均每次设备I/O操作的服务时间（以毫秒为单位）。如果svctm的值与await很接近，表示几乎没有I/O等待，磁盘性能很好，如果await的值远高于svctm的值，则表示I/O队列等待太长，       系统上运行的应用程序将变慢。</li></ul><hr><ul><li>kB_read/s：每秒从设备读取的数据量；</li><li>kB_wrtn/s：每秒向设备写入的数据量；</li><li>kB_read：读取的总数据量；</li><li>kB_wrtn：写入的总数量数据量；<br>-rrqm/s：每秒这个设备相关的读取请求有多少被Merge了（当系统调用需要读取数据的时候，VFS将请求发到各个FS，如果FS发现不同的读取请求读取的是相同Block的数据，FS会将这个请求合并Merge）；wrqm/s：每秒这个设备相关的写入请求有多少被Merge了。</li><li>rsec/s：每秒读取的扇区数；</li><li>wsec/：每秒写入的扇区数。</li><li>rKB/s：The number of read requests that were issued to the device per second；</li><li>wKB/s：The number of write requests that were issued to the device per second；</li><li>avgrq-sz：平均请求扇区的大小</li><li>avgqu-sz：是平均请求队列的长度。毫无疑问，队列长度越短越好。    </li></ul><hr><ul><li><p>IOPS：每秒处理读/写请求的数量，即iostat输出中的r/s和w/s，个人PC的机械硬盘IOPS一般在100左右，而各种公有云/私有云的普通服务器，也只在百这个数量级。</p><blockquote><p>预先获取到所用服务区的IOPS能力，然后在性能测试中监控试试的IOPS数据，来衡量当前的磁盘是否能满足系统的IO需求。</p></blockquote></li><li><p>数据吞吐量：每秒读/写的数据大小，即iostat输出中的rkB/s和wkB/s，通常磁盘的数据吞吐量与IO类型有直接关系，顺序IO的吞吐能力明显优与随机读写，可以预先测得磁盘在随机IO和顺序IO下的吞吐量，以便于测试时监控到的数据进行比较衡量。</p></li></ul><hr><h4 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h4><p>网络本身是系统中一个非常复杂的部分，但常规的服务端性能测试通常放在一个局域网进行，因为我们首先关注被测系统自身的性能表现，并且需要保证能在较少的成本下发起足够大的压力。</p><p>因此对于多数系统的性能测试，我们主要关注<strong>网络吞吐量</strong>即可，对于稳定运行的系统，需要为被测场景外的业务流出足够的带宽；在压力测试过程中，需要注意瓶颈可能来自于带宽。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptraf -d eth0</span><br></pre></td></tr></table></figure><hr><h3 id="Performance-Tools"><a href="#Performance-Tools" class="headerlink" title="Performance Tools"></a>Performance Tools</h3><ul><li>wrk</li><li>ab</li><li>locust</li><li>Jmeter</li></ul><hr><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><blockquote><p><a href="https://testerhome.com/topics/17068" target="_blank" rel="noopener">https://testerhome.com/topics/17068</a><br><a href="https://zhuanlan.zhihu.com/p/22070862" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/22070862</a><br><a href="http://www.aloo.me/2016/08/01/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E4%B8%AD%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%85%B3%E9%94%AE%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87%E6%B5%85%E6%9E%90/" target="_blank" rel="noopener">http://www.aloo.me/2016/08/01/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E4%B8%AD%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%85%B3%E9%94%AE%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87%E6%B5%85%E6%9E%90/</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;h3 id=&quot;Performance-Metric&quot;&gt;&lt;a href=&quot;#Performance-Metric&quot; class=&quot;headerlink&quot; title=&quot;Performance Metric&quot;&gt;&lt;/a&gt;Performance Metric&lt;/h3&gt;&lt;h4 
      
    
    </summary>
    
      <category term="Testing" scheme="https://sulangsss.github.io/categories/Testing/"/>
    
    
      <category term="TechStack" scheme="https://sulangsss.github.io/tags/TechStack/"/>
    
      <category term="Testing" scheme="https://sulangsss.github.io/tags/Testing/"/>
    
  </entry>
  
  <entry>
    <title>Influxdb Command</title>
    <link href="https://sulangsss.github.io/2019/03/16/DB/Influxdb/Influxdb-Command/"/>
    <id>https://sulangsss.github.io/2019/03/16/DB/Influxdb/Influxdb-Command/</id>
    <published>2019-03-16T07:00:27.000Z</published>
    <updated>2019-03-16T07:19:57.878Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Basic-Command"><a href="#Basic-Command" class="headerlink" title="Basic Command"></a>Basic Command</h3><h4 id="Connect"><a href="#Connect" class="headerlink" title="Connect"></a>Connect</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">influx -precision rfc3339</span><br><span class="line"></span><br><span class="line"><span class="comment"># The -precision argument specifies the format/precision of any returned timestamps</span></span><br><span class="line"><span class="comment"># rfc3339 tells InfluxDB to return timestamps in RFC3339 format (YYYY-MM-DDTHH:MM:SS.nnnnnnnnnZ)</span></span><br></pre></td></tr></table></figure><h4 id="Auth"><a href="#Auth" class="headerlink" title="Auth"></a>Auth</h4><ol><li><p>Auth User</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auth</span><br></pre></td></tr></table></figure></li><li><p>Authenticate Telegraf requests to InfluxDB</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Write timeout (for the InfluxDB client), formatted as a string.</span></span><br><span class="line"><span class="comment">## If not provided, will default to 5s. 0s means no timeout (not recommended).</span></span><br><span class="line">timeout = <span class="string">"5s"</span></span><br><span class="line">username = <span class="string">"telegraf"</span> <span class="comment">#💥</span></span><br><span class="line">password = <span class="string">"metricsmetricsmetricsmetrics"</span> <span class="comment">#💥</span></span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Basic-Command&quot;&gt;&lt;a href=&quot;#Basic-Command&quot; class=&quot;headerlink&quot; title=&quot;Basic Command&quot;&gt;&lt;/a&gt;Basic Command&lt;/h3&gt;&lt;h4 id=&quot;Connect&quot;&gt;&lt;a href=&quot;#Co
      
    
    </summary>
    
      <category term="DB" scheme="https://sulangsss.github.io/categories/DB/"/>
    
      <category term="Influxdb" scheme="https://sulangsss.github.io/categories/DB/Influxdb/"/>
    
    
      <category term="Influxdb" scheme="https://sulangsss.github.io/tags/Influxdb/"/>
    
      <category term="Command" scheme="https://sulangsss.github.io/tags/Command/"/>
    
  </entry>
  
  <entry>
    <title>Multi-container pods and container communication in Kubernetes</title>
    <link href="https://sulangsss.github.io/2019/03/16/Kubenetes/MultipleContainerOnDeployment/"/>
    <id>https://sulangsss.github.io/2019/03/16/Kubenetes/MultipleContainerOnDeployment/</id>
    <published>2019-03-16T06:00:27.000Z</published>
    <updated>2019-03-16T06:36:03.265Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul><li><a href="https://www.mirantis.com/blog/multi-container-pods-and-container-communication-in-kubernetes/" target="_blank" rel="noopener">https://www.mirantis.com/blog/multi-container-pods-and-container-communication-in-kubernetes/</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Reference&quot;&gt;&lt;a href=&quot;#Reference&quot; class=&quot;headerlink&quot; title=&quot;Reference&quot;&gt;&lt;/a&gt;Reference&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.mirantis.com/bl
      
    
    </summary>
    
      <category term="Kubernetes" scheme="https://sulangsss.github.io/categories/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="https://sulangsss.github.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://sulangsss.github.io/2019/02/13/Security/Web/DDoS/"/>
    <id>https://sulangsss.github.io/2019/02/13/Security/Web/DDoS/</id>
    <published>2019-02-13T04:29:10.326Z</published>
    <updated>2019-02-13T04:29:10.326Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://sulangsss.github.io/2019/02/13/Security/Web/SQL-Injection/"/>
    <id>https://sulangsss.github.io/2019/02/13/Security/Web/SQL-Injection/</id>
    <published>2019-02-13T04:28:48.591Z</published>
    <updated>2019-02-13T04:28:48.591Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://sulangsss.github.io/2019/02/13/Security/Web/XSS/"/>
    <id>https://sulangsss.github.io/2019/02/13/Security/Web/XSS/</id>
    <published>2019-02-13T04:28:36.344Z</published>
    <updated>2019-02-13T04:28:36.344Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://sulangsss.github.io/2019/02/13/Security/Web/CSRF/"/>
    <id>https://sulangsss.github.io/2019/02/13/Security/Web/CSRF/</id>
    <published>2019-02-13T04:28:23.056Z</published>
    <updated>2019-02-13T04:28:23.056Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Technology Stack On Java</title>
    <link href="https://sulangsss.github.io/2019/02/13/Java/TechStack/"/>
    <id>https://sulangsss.github.io/2019/02/13/Java/TechStack/</id>
    <published>2019-02-13T02:00:22.000Z</published>
    <updated>2019-03-12T03:00:00.652Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Spring-Boot"><a href="#Spring-Boot" class="headerlink" title="Spring Boot"></a>Spring Boot</h3><h4 id="Trace"><a href="#Trace" class="headerlink" title="Trace"></a>Trace</h4><ul><li>Skywalking</li><li>Zipkin</li></ul><h4 id="Register-Center"><a href="#Register-Center" class="headerlink" title="Register Center"></a>Register Center</h4><ul><li>Eureke</li><li>Consul</li></ul><hr><h3 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h3><ul><li>jib：Jib builds optimized Docker and OCI images for your Java applications without a Docker daemon - and without deep mastery of Docker best-practices. It is available as plugins for Maven and Gradle and as a Java library.</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Spring-Boot&quot;&gt;&lt;a href=&quot;#Spring-Boot&quot; class=&quot;headerlink&quot; title=&quot;Spring Boot&quot;&gt;&lt;/a&gt;Spring Boot&lt;/h3&gt;&lt;h4 id=&quot;Trace&quot;&gt;&lt;a href=&quot;#Trace&quot; class
      
    
    </summary>
    
      <category term="Java" scheme="https://sulangsss.github.io/categories/Java/"/>
    
    
      <category term="TechStack" scheme="https://sulangsss.github.io/tags/TechStack/"/>
    
      <category term="Java" scheme="https://sulangsss.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>RSI是什么？</title>
    <link href="https://sulangsss.github.io/2019/02/01/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E8%A1%8C%E4%B8%9A/%E9%87%91%E8%9E%8D/RSI/"/>
    <id>https://sulangsss.github.io/2019/02/01/读书笔记/行业/金融/RSI/</id>
    <published>2019-02-01T03:24:07.000Z</published>
    <updated>2019-02-11T02:56:41.201Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>相对强弱指数RSI最早被用于期货交易中，后来发现用该指标来指导股票市场投资效果也十分不错，并对该指标的特点不断进行归纳和总结。现在，RSI已经成为被投资者应用最广泛的技术指标之一，今天就来为大家简单介绍相对强弱指标，还有到底应该如何计算呢？</p><p><strong>相对强弱指标(Relative Strength Index)简称为RSI，是一种用来评估「买卖盘双方力道强弱」情况的技术指标，买家是代表金钱的力量，卖家是代表持货的力量。</strong>当买方力量稍逊，价格就会向下发展；相反，当卖方力量不足，价格就会向上发展。</p><hr><h3 id="RSI计算方式"><a href="#RSI计算方式" class="headerlink" title="RSI计算方式"></a>RSI计算方式</h3><p>这项技术指标是由技术分析大师为韦尔斯‧怀德(Wells Wilder) 所发明的，同时也是目前流传最广且最常被人使用的技术指标之一。</p><p>强弱指标(RSI)以计算价格的涨跌为基础，考虑了股价变动的四个因素：上涨和下跌的天数、上涨和下跌的幅度。在股价趋势预测方面，其准确度相当高。</p><h4 id="举例说明"><a href="#举例说明" class="headerlink" title="举例说明"></a>举例说明</h4><p>假设每天涨幅如下图所示：</p><p>计算RSI的步骤如下：</p><p>将6天上升的数目相加，除以6，上例中总共上升10元除以6得1.667</p><p>将6天下跌的数目相加，除以6，上例中总共下跌4元除以6得0.667</p><p>求出相对强度RS，即RS=1.667/0.6​​67=2.4993，再将结果套入公式二即可求解：14天的强弱指标RS1为71.423</p><h4 id="解读RSI"><a href="#解读RSI" class="headerlink" title="解读RSI"></a>解读RSI</h4><p>RSI把相对强度的数值定义在 0~100之间，如此更能方便参考使用。而多天期的RSI (即n值较大) 其讯号将更具参考性。</p><p>RSI数值越大代表买方力道越强，但强弩之末总会衰竭，因此当RSI大到某一程度时通常开始代表买超现象，需注意反转。同理，当RSI低到某一程度时，通常代表市场出现非理性的卖超现象，表示底部区已近 。</p><p>一般来说，RSI有以下研判功能：</p><ul><li>买超、卖超、持平</li><li>反转讯号</li><li>背离讯号</li><li>买入卖出讯号</li></ul><p>注意事项：</p><ol><li><p>RSI指标在高档或低档有时会有钝化的现象，因此会发生过早卖出或买进。</p></li><li><p>RSI只能作为一个警告讯号，并不意味着市势必然朝这个方向发展，尤其在市场剧烈震荡时，超卖还有超卖，超买还有超买，这时须参考其他指标综合分析，像是利用长天期的RSI均线与RSI线的关系来作买卖讯号判断，不能单独依赖RSI的讯号而作出买卖决定。</p></li><li><p>背离走势的讯号通常者都是事后历史，而且有背离走势发生之后，行情并无反转的现象。有时背离一，二次才真正反转，因此这方面研判须不断分析历史资料以提高经验。</p></li><li><p>由于RSI是一种比率的指标，因此在趋势分析的能力上会较弱。</p></li><li><p>盘势进入横盘整理时，长短天期的RSI也容易形成重复交叉的情形。</p></li></ol><hr><h3 id="Refference"><a href="#Refference" class="headerlink" title="Refference"></a>Refference</h3><blockquote><p><a href="https://wiki.mbalib.com/wiki/%E7%9B%B8%E5%AF%B9%E5%BC%BA%E5%BC%B1%E6%8C%87%E6%A0%87" target="_blank" rel="noopener">https://wiki.mbalib.com/wiki/%E7%9B%B8%E5%AF%B9%E5%BC%BA%E5%BC%B1%E6%8C%87%E6%A0%87</a><br><a href="https://journal.eyeprophet.com/%E6%95%99%E4%BD%A0%E7%9C%8B%E6%87%82-rsi-%E7%9B%B8%E5%B0%8D%E5%BC%B7%E5%BC%B1%E6%8C%87%E6%A8%99/" target="_blank" rel="noopener">https://journal.eyeprophet.com/%E6%95%99%E4%BD%A0%E7%9C%8B%E6%87%82-rsi-%E7%9B%B8%E5%B0%8D%E5%BC%B7%E5%BC%B1%E6%8C%87%E6%A8%99/</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Introduction&quot;&gt;&lt;a href=&quot;#Introduction&quot; class=&quot;headerlink&quot; title=&quot;Introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h3&gt;&lt;p&gt;相对强弱指数RSI最早被用于期货交易中，后来发现用该指标来指
      
    
    </summary>
    
      <category term="Finance" scheme="https://sulangsss.github.io/categories/Finance/"/>
    
    
      <category term="Finance" scheme="https://sulangsss.github.io/tags/Finance/"/>
    
      <category term="金融" scheme="https://sulangsss.github.io/tags/%E9%87%91%E8%9E%8D/"/>
    
      <category term="RSI" scheme="https://sulangsss.github.io/tags/RSI/"/>
    
  </entry>
  
  <entry>
    <title>Java AtomicLong 和 LongAdder</title>
    <link href="https://sulangsss.github.io/2019/02/01/Java/Advance/AtomicLong%E5%92%8CLongAddr/"/>
    <id>https://sulangsss.github.io/2019/02/01/Java/Advance/AtomicLong和LongAddr/</id>
    <published>2019-02-01T03:01:22.000Z</published>
    <updated>2019-02-11T02:55:47.632Z</updated>
    
    <content type="html"><![CDATA[<h3 id="AtomicLong"><a href="#AtomicLong" class="headerlink" title="AtomicLong"></a>AtomicLong</h3><p>AtomicLong是JUC包提供的原子性操作类，其内部通过CAS保证了对计数的原子性更新操作。</p><blockquote><p>java.util.concurrent.atomi</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Atomically increments by one the current value.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> the previous value</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> <span class="title">getAndIncrement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> unsafe.getAndAddLong(<span class="keyword">this</span>, valueOffset, <span class="number">1L</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>内部是通过UnSafe(rt.jar)这个类的CAS操作来保证对内部的计数器变量long value进行原子性更新的。其中unsafe.getAndAddLong的代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> <span class="title">getAndAddLong</span><span class="params">(Object var1, <span class="keyword">long</span> var2, <span class="keyword">long</span> var4)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> var6;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        var6 = <span class="keyword">this</span>.getLongVolatile(var1, var2);    <span class="comment">//(1)</span></span><br><span class="line">    &#125; <span class="keyword">while</span>(!<span class="keyword">this</span>.compareAndSwapLong(var1, var2, var6, var6 + var4)); <span class="comment">//(2)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> var6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可知最终调用的是native方法compareAndSwapLong原子性操作。</p><p>假如多个线程调用同一个AtomicLong对象进行更新操作(getAndIncrement)，会发生什么事情？</p><p>多个线程都会执行到unsafe.getAndAddLong方法，然后多个线程都会执行到代码(1)处获取计数器的值。接着多个线程再去(2)尝试更新值，由于CAS具有原子性，所以只有一个线程会更新成功，然后返回true从而退出循环，整个更新操作就完成了。其他线程则CAS失败后返回false，则循环一次在次从(1)处获取当前计数器的值，然后在尝试执行(2)，这叫做CAS的自旋操作，本质是使用CPU资源换取使用锁带来的上下文切换等开销。</p><hr><h3 id="LongAdder"><a href="#LongAdder" class="headerlink" title="LongAdder"></a>LongAdder</h3><p>AtomicLong类为开发人员使用线程安全的计数器提供了方便，但是AtomicLong在高并发下存在一些问题。比如，当大量线程调用同一个AtomicLong的实例的方法时候，同时只有一个线程会CAS计数器的值成功，失败的线程则会原地占用cpu进行自旋转重试，这回造成大量线程白白浪费CPU原地自旋转。</p><p>在JDK8中新增了一个LongAdder类，其采用分而治之的策略来减少同一个变量的并发竞争度，<strong>LongAdder的核心思想是把一个原子变量分解为多个变量，让同样多的线程去竞争多个资源，这样竞争每个资源的线程数就被分担了下来。</strong></p><img src="/2019/02/01/Java/Advance/AtomicLong和LongAddr/LongAddr-CAS.png"><p>在LongAdder的底层实现中，首先有一个base值，刚开始多线程来不停的累加数值，都是对base进行累加的，比如刚开始累加成了base = 5。接着如果发现并发更新的线程数量过多，就会开始施行分段CAS的机制，也就是内部会搞一个Cell数组，每个数组是一个数值分段。</p><p>这时，让大量的线程分别去对不同Cell内部的value值进行CAS累加操作，这样就把CAS计算压力分散到了不同的Cell分段数值中了。这样就可以大幅度的降低多线程并发更新同一个数值时出现的无限循环的问题，大幅度提升了多线程并发更新数值的性能和效率。</p><p>而且LongAdder内部实现了自动分段迁移的机制，也就是如果某个Cell的value执行CAS失败了，那么就会自动去找另外一个Cell分段内的value值进行CAS操作。这样也解决了线程空旋转、自旋不停等待执行CAS操作的问题，让一个线程过来执行CAS时可以尽快的完成这个操作。</p><p>最后，如果你要从LongAdder中获取当前累加的总值，就会把base值和所有Cell分段数值加起来返回给你。</p><h4 id="Analyze-Source-Code"><a href="#Analyze-Source-Code" class="headerlink" title="Analyze Source Code"></a>Analyze Source Code</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Number of CPUS, to place bound on table size */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NCPU = Runtime.getRuntime().availableProcessors();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Table of cells. When non-null, size is a power of 2.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> Cell[] cells;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Base value, used mainly when there is no contention, but also as</span></span><br><span class="line"><span class="comment">* a fallback during table initialization races. Updated via CAS.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">long</span> base;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Spinlock (locked via CAS) used when resizing and/or creating Cells.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> cellsBusy;</span><br><span class="line"></span><br><span class="line"><span class="meta">@sun</span>.misc.Contended <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Cell</span> </span>&#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">long</span> value;</span><br><span class="line">    Cell(<span class="keyword">long</span> x) &#123; value = x; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">cas</span><span class="params">(<span class="keyword">long</span> cmp, <span class="keyword">long</span> val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UNSAFE.compareAndSwapLong(<span class="keyword">this</span>, valueOffset, cmp, val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Unsafe mechanics</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe UNSAFE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> valueOffset;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            UNSAFE = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">            Class&lt;?&gt; ak = Cell.class;</span><br><span class="line">            valueOffset = UNSAFE.objectFieldOffset(ak.getDeclaredField(<span class="string">"value"</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LongAdder维护了一个延迟初始化的原子性更新数组（默认情况下Cell数组是null）和一个基值变量base，由于Cells占用内存是相对比较大的，所以一开始并不创建，而是在需要时候在创建，也就是惰性创建。</p><p>当一开始判断cell数组是null并且并发线程较少时候所有的累加操作都是对base变量进行的，这时候就退化为了AtomicLong。cell数组的大小保持是2的N次方大小，初始化时候Cell数组的中Cell的元素个数为2，数组里面的变量实体是Cell类型。</p><p>当多个线程在争夺同一个Cell原子变量时候如果失败并不是在当前cell变量上一直自旋CAS重试，而是会尝试在其它Cell的变量上进行CAS尝试，这个改变增加了当前线程重试时候CAS成功的可能性。</p><p>LongAdder返回的值是把所有Cell变量的value值累加后再加上base值，如下代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">sum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Cell[] as = cells; Cell a;</span><br><span class="line">    <span class="keyword">long</span> sum = base;</span><br><span class="line">    <span class="keyword">if</span> (as != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((a = as[i]) != <span class="keyword">null</span>)</span><br><span class="line">                sum += a.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="QA"><a href="#QA" class="headerlink" title="QA"></a>QA</h4><ul><li>何时初始化cell数组?</li><li>当前线程如何选择cell中的元素进行访问?</li><li>如果保证cell中元素更新的线程安全?</li><li>cell数组何时进行扩容，cell元素个数可以无限扩张?</li></ul><hr><h3 id="Refference"><a href="#Refference" class="headerlink" title="Refference"></a>Refference</h3><blockquote><p><a href="http://ifeve.com/juc1/" target="_blank" rel="noopener">http://ifeve.com/juc1/</a><br><a href="https://juejin.im/post/5c062c87e51d451dbc21801b" target="_blank" rel="noopener">https://juejin.im/post/5c062c87e51d451dbc21801b</a><br><a href="http://blog.palominolabs.com/2014/02/10/java-8-performance-improvements-longadder-vs-atomiclong/" target="_blank" rel="noopener">http://blog.palominolabs.com/2014/02/10/java-8-performance-improvements-longadder-vs-atomiclong/</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;AtomicLong&quot;&gt;&lt;a href=&quot;#AtomicLong&quot; class=&quot;headerlink&quot; title=&quot;AtomicLong&quot;&gt;&lt;/a&gt;AtomicLong&lt;/h3&gt;&lt;p&gt;AtomicLong是JUC包提供的原子性操作类，其内部通过CAS保证了对计
      
    
    </summary>
    
      <category term="Java" scheme="https://sulangsss.github.io/categories/Java/"/>
    
      <category term="Advance" scheme="https://sulangsss.github.io/categories/Java/Advance/"/>
    
    
      <category term="Java" scheme="https://sulangsss.github.io/tags/Java/"/>
    
      <category term="LongAdder" scheme="https://sulangsss.github.io/tags/LongAdder/"/>
    
      <category term="AtomicLong" scheme="https://sulangsss.github.io/tags/AtomicLong/"/>
    
      <category term="CAS" scheme="https://sulangsss.github.io/tags/CAS/"/>
    
  </entry>
  
  <entry>
    <title>FireFox DNS over HTTPS</title>
    <link href="https://sulangsss.github.io/2019/01/30/Firefox/FirefoxDNS/"/>
    <id>https://sulangsss.github.io/2019/01/30/Firefox/FirefoxDNS/</id>
    <published>2019-01-30T02:13:06.000Z</published>
    <updated>2019-01-30T02:23:32.250Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h3><ol><li>在地址栏中执行about:config打开浏览器配置选项，设置network.trr.mode为2，设置为2表示使用DNS over HTTPS作为浏览器的DNS查询首选项，但也将常规DNS查询作为后备，2是兼容性最佳设置。您可以将其设置为1，让Firefox选择更快的模式；3使用TRR only模式，或者使用 0 来禁用该功能。</li><li>network.trr.uri，该首选项设置要使用的 DNS over HTTPS 服务器。默认的是<a href="https://mozilla.cloudflare-dns.com/dns-query，也可以选择下面的服务商：" target="_blank" rel="noopener">https://mozilla.cloudflare-dns.com/dns-query，也可以选择下面的服务商：</a></li></ol><ul><li><a href="https://cloudflare-dns.com/dns-query" target="_blank" rel="noopener">https://cloudflare-dns.com/dns-query</a></li><li><a href="https://dns.google.com/experimental" target="_blank" rel="noopener">https://dns.google.com/experimental</a></li></ul><ol start="3"><li>如果你选择了cloudflare，可以把network.trr.bootstrapAddress设置为1.1.1.1 / 1.0.0.1</li></ol><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><blockquote><p><a href="https://www.sysgeek.cn/configure-dns-over-https-in-firefox/" target="_blank" rel="noopener">https://www.sysgeek.cn/configure-dns-over-https-in-firefox/</a><br><a href="https://zhuanlan.zhihu.com/p/42468805" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/42468805</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Usage&quot;&gt;&lt;a href=&quot;#Usage&quot; class=&quot;headerlink&quot; title=&quot;Usage&quot;&gt;&lt;/a&gt;Usage&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;在地址栏中执行about:config打开浏览器配置选项，设置network.trr.mode为2，设置
      
    
    </summary>
    
      <category term="Firefox" scheme="https://sulangsss.github.io/categories/Firefox/"/>
    
    
      <category term="FireFox" scheme="https://sulangsss.github.io/tags/FireFox/"/>
    
      <category term="DNS" scheme="https://sulangsss.github.io/tags/DNS/"/>
    
      <category term="HTTPS" scheme="https://sulangsss.github.io/tags/HTTPS/"/>
    
  </entry>
  
  <entry>
    <title>False Sharing</title>
    <link href="https://sulangsss.github.io/2019/01/28/Java/Advance/Memory/FalseSharing/"/>
    <id>https://sulangsss.github.io/2019/01/28/Java/Advance/Memory/FalseSharing/</id>
    <published>2019-01-28T08:13:06.000Z</published>
    <updated>2019-02-01T03:16:02.024Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>缓存系统中是以缓存行（cache line）为单位存储的。缓存行是2的整数幂个连续字节，一般为32-256个字节。最常见的缓存行大小是64个字节。当多线程修改互相独立的变量时，如果这些变量共享同一个缓存行，就会无意中影响彼此的性能，这就是伪共享。缓存行上的写竞争是运行在SMP系统中并行线程实现可伸缩性最重要的限制因素。有人将伪共享描述成无声的性能杀手，因为从代码中很难看清楚是否会出现伪共享。 </p><p>为了让可伸缩性与线程数呈线性关系，就必须确保不会有两个线程往同一个变量或缓存行中写。两个线程写同一个变量可以在代码中发现。为了确定互相独立的变量是否共享了同一个缓存行，就需要了解内存布局。</p><hr><img src="/2019/01/28/Java/Advance/Memory/FalseSharing/cache-line.png"><p>在核心1上运行的线程想更新变量X，同时核心2上的线程想要更新变量Y。不幸的是，这两个变量在同一个缓存行中。每个线程都要去竞争缓存行的所有权来更新变量。如果核心1获得了所有权，缓存子系统将会使核心2中对应的缓存行失效。当核心2获得了所有权然后执行更新操作，核心1就要使自己对应的缓存行失效。这会来来回回的经过L3缓存，大大影响了性能。如果互相竞争的核心位于不同的插槽，就要额外横跨插槽连接，问题可能更加严重。 </p><hr><h3 id="Java-Memory-Layout"><a href="#Java-Memory-Layout" class="headerlink" title="Java Memory Layout"></a>Java Memory Layout</h3><p>对于HotSpot JVM(32位)，所有对象都有两个字(32位 + 32位)的对象头：</p><ul><li>第一个字是由24位哈希码和8位标志位（如锁的状态或作为锁对象）组成的Mark Word。</li><li>第二个字是对象所属类的引用(如果是数组对象还需要一个额外的字来存储数组的长度)。</li></ul><p>每个对象的起始地址都对齐于8字节以提高性能。因此当封装对象的时候为了高效率，对象字段声明的顺序会被重排序成下列基于字节大小的顺序：</p><ul><li>doubles (8) 和 longs (8)</li><li>ints (4) 和 floats (4)</li><li>shorts (2) 和 chars (2)</li><li>booleans (1) 和 bytes (1)</li><li>references (4/8)</li></ul><hr><h3 id="Performance-Testing"><a href="#Performance-Testing" class="headerlink" title="Performance Testing"></a>Performance Testing</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VolatileLong</span>(</span></span><br><span class="line"><span class="class">    @<span class="title">Volatile</span></span></span><br><span class="line">    var value: Long = 0</span><br><span class="line">) &#123;</span><br><span class="line">   <span class="comment">// if comment below code, happen false sharing</span></span><br><span class="line">   var p1: Long = <span class="number">0</span></span><br><span class="line">   var p2: Long = <span class="number">0</span></span><br><span class="line">   var p3: Long = <span class="number">0</span></span><br><span class="line">   var p4: Long = <span class="number">0</span></span><br><span class="line">   var p5: Long = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FalseSharing</span>(</span></span><br><span class="line">    private val threadCount: Int = 4,</span><br><span class="line">    <span class="keyword">private</span> val loopTimes: Long = <span class="number">500</span> * <span class="number">1000L</span> * <span class="number">1000L</span></span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">private</span> val vlongs: Array&lt;VolatileLong&gt; = Array(threadCount) &#123; VolatileLong() &#125;</span><br><span class="line">    <span class="keyword">private</span> val threads = arrayListOf&lt;Thread&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="function">fun <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (index in <span class="number">0</span> until threadCount) &#123;</span><br><span class="line">            threads.add(thread &#123;</span><br><span class="line">                <span class="comment">//  println("Thread $&#123;Thread.currentThread().id&#125; start")</span></span><br><span class="line">                var end = loopTimes + index</span><br><span class="line">                <span class="keyword">while</span> (end != <span class="number">0L</span>) &#123;</span><br><span class="line">                    vlongs[index].value = end</span><br><span class="line">                    end -= <span class="number">1</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//  println("Thread $&#123;Thread.currentThread().id&#125; stop")</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (thread in threads) &#123;</span><br><span class="line">            thread.join()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">fun <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//  50亿</span></span><br><span class="line">    val times = <span class="number">500</span> * <span class="number">1000L</span> * <span class="number">1000L</span></span><br><span class="line">    val begin = System.currentTimeMillis()</span><br><span class="line">    FalseSharing(loopTimes = times).start()</span><br><span class="line">    val end = System.currentTimeMillis()</span><br><span class="line">    println(<span class="string">"consume time ($times): $&#123;end - begin&#125;"</span>)</span><br><span class="line">    <span class="comment">//  no false sharing: consume time (500000000): 3278 ms</span></span><br><span class="line">    <span class="comment">//  false sharing: consume time (500000000): 44364</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="Code-Tools-jol"><a href="#Code-Tools-jol" class="headerlink" title="Code Tools: jol"></a>Code Tools: jol</h3><p>JOL (Java Object Layout) is the tiny toolbox to analyze object layout schemes in JVMs.</p><h4 id="Command-Line-Tool"><a href="#Command-Line-Tool" class="headerlink" title="Command Line Tool"></a>Command Line Tool</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">java -jar jol-cli-0.9-full.jar internals java.lang.Long</span><br><span class="line"></span><br><span class="line"><span class="comment"># Running 64-bit HotSpot VM.</span></span><br><span class="line"><span class="comment"># Using compressed oop with 3-bit shift.</span></span><br><span class="line"><span class="comment"># Using compressed klass with 3-bit shift.</span></span><br><span class="line"><span class="comment"># WARNING | Compressed references base/shifts are guessed by the experiment!</span></span><br><span class="line"><span class="comment"># WARNING | Therefore, computed addresses are just guesses, and ARE NOT RELIABLE.</span></span><br><span class="line"><span class="comment"># WARNING | Make sure to attach Serviceability Agent to get the reliable addresses.</span></span><br><span class="line"><span class="comment"># Objects are 8 bytes aligned.</span></span><br><span class="line"><span class="comment"># Field sizes by type: 4, 1, 1, 2, 2, 4, 4, 8, 8 [bytes]</span></span><br><span class="line"><span class="comment"># Array element sizes: 4, 1, 1, 2, 2, 4, 4, 8, 8 [bytes]</span></span><br><span class="line"></span><br><span class="line">Instantiated the sample instance via public java.lang.Long(long)</span><br><span class="line"></span><br><span class="line">java.lang.Long object internals:</span><br><span class="line"> OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           f4 22 00 f8 (11110100 00100010 00000000 11111000) (-134208780)</span><br><span class="line">     12     4        (alignment/padding gap)                  </span><br><span class="line">     16     8   long Long.value                                0</span><br><span class="line">Instance size: 24 bytes</span><br><span class="line">Space losses: 4 bytes internal + 0 bytes external = 4 bytes total</span><br></pre></td></tr></table></figure><h4 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjdk.jol<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jol-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VolatileLong</span>(</span></span><br><span class="line"><span class="class">    @<span class="title">Volatile</span></span></span><br><span class="line">    var value: Long = 0</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    var p1: Long = 0</span></span><br><span class="line"><span class="comment">    var p2: Long = 0</span></span><br><span class="line"><span class="comment">    var p3: Long = 0</span></span><br><span class="line"><span class="comment">    var p4: Long = 0</span></span><br><span class="line"><span class="comment">    var p5: Long = 0</span></span><br><span class="line"><span class="comment">    var p6: Long = 0</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">fun <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    println(VM.current().details())</span><br><span class="line">    println(ClassLayout.parseClass(VolatileLong::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>).<span class="title">toPrintable</span>())</span></span><br><span class="line"><span class="class">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># WARNING: Unable to attach Serviceability Agent. You can try again with escalated privileges. Two options: a) use -Djol.tryWithSudo=true to try with sudo; b) echo 0 | sudo tee /proc/sys/kernel/yama/ptrace_scope</span></span><br><span class="line"><span class="comment"># Running 64-bit HotSpot VM.</span></span><br><span class="line"><span class="comment"># Using compressed oop with 3-bit shift.</span></span><br><span class="line"><span class="comment"># Using compressed klass with 3-bit shift.</span></span><br><span class="line"><span class="comment"># WARNING | Compressed references base/shifts are guessed by the experiment!</span></span><br><span class="line"><span class="comment"># WARNING | Therefore, computed addresses are just guesses, and ARE NOT RELIABLE.</span></span><br><span class="line"><span class="comment"># WARNING | Make sure to attach Serviceability Agent to get the reliable addresses.</span></span><br><span class="line"><span class="comment"># Objects are 8 bytes aligned.</span></span><br><span class="line"><span class="comment"># Field sizes by type: 4, 1, 1, 2, 2, 4, 4, 8, 8 [bytes]</span></span><br><span class="line"><span class="comment"># Array element sizes: 4, 1, 1, 2, 2, 4, 4, 8, 8 [bytes]</span></span><br><span class="line"></span><br><span class="line">com.demo.falsesharing.VolatileLong object internals:</span><br><span class="line"> OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0    12        (object header)                           N/A</span><br><span class="line">     12     4        (alignment/padding gap)                  </span><br><span class="line">     16     8   long VolatileLong.value                        N/A</span><br><span class="line">Instance size: 24 bytes</span><br><span class="line">Space losses: 4 bytes internal + 0 bytes external = 4 bytes total</span><br></pre></td></tr></table></figure><p>如果希望VolatileLong在一个cache line上，可以修改为</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VolatileLong</span>(</span></span><br><span class="line"><span class="class">    @<span class="title">Volatile</span></span></span><br><span class="line">    var value: Long = 0</span><br><span class="line">) &#123;</span><br><span class="line">    var p1: Long = <span class="number">0</span></span><br><span class="line">    var p2: Long = <span class="number">0</span></span><br><span class="line">    var p3: Long = <span class="number">0</span></span><br><span class="line">    var p4: Long = <span class="number">0</span></span><br><span class="line">    var p5: Long = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">fun <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    println(VM.current().details())</span><br><span class="line">    println(ClassLayout.parseClass(VolatileLong::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>).<span class="title">toPrintable</span>())</span></span><br><span class="line"><span class="class">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">com.demo.falsesharing.VolatileLong object internals:</span><br><span class="line"> OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0    12        (object header)                           N/A</span><br><span class="line">     12     4        (alignment/padding gap)                  </span><br><span class="line">     16     8   long VolatileLong.p1                           N/A</span><br><span class="line">     24     8   long VolatileLong.p2                           N/A</span><br><span class="line">     32     8   long VolatileLong.p3                           N/A</span><br><span class="line">     40     8   long VolatileLong.p4                           N/A</span><br><span class="line">     48     8   long VolatileLong.p5                           N/A</span><br><span class="line">     56     8   long VolatileLong.value                        N/A</span><br><span class="line">Instance size: 64 bytes</span><br><span class="line">Space losses: 4 bytes internal + 0 bytes external = 4 bytes total</span><br></pre></td></tr></table></figure><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><blockquote><p><a href="https://mechanical-sympathy.blogspot.com/2011/07/false-sharing.html" target="_blank" rel="noopener">https://mechanical-sympathy.blogspot.com/2011/07/false-sharing.html</a><br><a href="http://openjdk.java.net/projects/code-tools/jol/" target="_blank" rel="noopener">http://openjdk.java.net/projects/code-tools/jol/</a><br><a href="http://ifeve.com/falsesharing/" target="_blank" rel="noopener">http://ifeve.com/falsesharing/</a><br><a href="http://hg.openjdk.java.net/code-tools/jol/file/tip/jol-samples/src/main/java/org/openjdk/jol/samples/" target="_blank" rel="noopener">http://hg.openjdk.java.net/code-tools/jol/file/tip/jol-samples/src/main/java/org/openjdk/jol/samples/</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Introduction&quot;&gt;&lt;a href=&quot;#Introduction&quot; class=&quot;headerlink&quot; title=&quot;Introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h3&gt;&lt;p&gt;缓存系统中是以缓存行（cache line）为单位存储的。缓
      
    
    </summary>
    
      <category term="Java" scheme="https://sulangsss.github.io/categories/Java/"/>
    
      <category term="Advance" scheme="https://sulangsss.github.io/categories/Java/Advance/"/>
    
      <category term="Memory" scheme="https://sulangsss.github.io/categories/Java/Advance/Memory/"/>
    
    
      <category term="Java" scheme="https://sulangsss.github.io/tags/Java/"/>
    
      <category term="FalseSharing" scheme="https://sulangsss.github.io/tags/FalseSharing/"/>
    
      <category term="Memory" scheme="https://sulangsss.github.io/tags/Memory/"/>
    
  </entry>
  
  <entry>
    <title>Inflation 通货膨胀 - 最厉害的小偷</title>
    <link href="https://sulangsss.github.io/2019/01/28/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E8%A1%8C%E4%B8%9A/%E9%87%91%E8%9E%8D/%E9%87%91%E8%9E%8D%E6%80%9D%E7%BB%B4/1.2%20Inflation/"/>
    <id>https://sulangsss.github.io/2019/01/28/读书笔记/行业/金融/金融思维/1.2 Inflation/</id>
    <published>2019-01-27T16:24:07.000Z</published>
    <updated>2019-02-02T03:27:04.326Z</updated>
    
    <content type="html"><![CDATA[<h3 id="什么是通货膨胀？"><a href="#什么是通货膨胀？" class="headerlink" title="什么是通货膨胀？"></a>什么是通货膨胀？</h3><p>简单地说，就是人们手里的资金贬值，物价上涨。</p><img src="/2019/01/28/读书笔记/行业/金融/金融思维/1.2%20Inflation/inflation-1.png"><p>这就是最简单的通货膨胀：<strong>钱变得不值钱了。</strong></p><p>我们个人的命运和财富与国家的经济政策其实息息相关。只有了解一个大环境的经济走势，才能更好地为个人财富保值、增值。</p><hr><h3 id="通货膨胀是怎么产生的？"><a href="#通货膨胀是怎么产生的？" class="headerlink" title="通货膨胀是怎么产生的？"></a>通货膨胀是怎么产生的？</h3><img src="/2019/01/28/读书笔记/行业/金融/金融思维/1.2%20Inflation/inflation-2.png"><img src="/2019/01/28/读书笔记/行业/金融/金融思维/1.2%20Inflation/inflation-3.png"><hr><h3 id="通货膨胀是好还是坏？"><a href="#通货膨胀是好还是坏？" class="headerlink" title="通货膨胀是好还是坏？"></a>通货膨胀是好还是坏？</h3><ul><li>温和的通货膨胀是合理的：当市场上的钱多了，货币增加了，意味着消<strong>费的需求也增加了</strong>。相应的<strong>企业生产活动和就业机会也会增加</strong>。</li></ul><hr><h3 id="CPI衡量通货膨胀的程度"><a href="#CPI衡量通货膨胀的程度" class="headerlink" title="CPI衡量通货膨胀的程度"></a>CPI衡量通货膨胀的程度</h3><p>CPI：居民消费价格指数，反应通货膨胀的程度。</p><p>我国CPI组成类别：</p><ul><li>食品(34%)</li><li>娱乐教育文化用品及服务(14%)</li><li>居住类(13%)</li><li>交通通讯(10%)</li><li>医疗保健个人用品(10%)</li><li>依着类(9%)</li><li>家庭设备及维修服务(6%)</li><li>烟酒及用品(4%)</li></ul><p>其中，食品是所有类商品中权重最大的分类项，而猪肉又是食品分类中最重要的子项目，约占CPI整体的9%的权重。</p><p>当CPI &gt; 3%的增幅时，我们称为通货膨胀；而当CPI &gt; 5%的增幅时，称为严重的通货膨胀。</p><p>大部分的经济学家们认为2%~4%的通货膨胀率对一个经济体是有好处的，它可以有效刺激经济增长，拉动社会的需求。既然温和的通货膨胀是一个常态，并且是一个政府追求的经济指标，那么这就意味着大家手里的钱非常大几率的今后每年都会以一定的比率(2%~4%)贬值。</p><hr><h3 id="如何战胜通货膨胀"><a href="#如何战胜通货膨胀" class="headerlink" title="如何战胜通货膨胀"></a>如何战胜通货膨胀</h3><img src="/2019/01/28/读书笔记/行业/金融/金融思维/1.2%20Inflation/inflation-4.png"><hr><h3 id="如何应对恶性通货膨胀"><a href="#如何应对恶性通货膨胀" class="headerlink" title="如何应对恶性通货膨胀"></a>如何应对恶性通货膨胀</h3><img src="/2019/01/28/读书笔记/行业/金融/金融思维/1.2%20Inflation/inflation-5.png"><p>对于个人而言，如果我们每年只是辛苦的工作，被动的存钱，虽然表面上看钱没动，但是实际价值却遭受到了很大的损失。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;什么是通货膨胀？&quot;&gt;&lt;a href=&quot;#什么是通货膨胀？&quot; class=&quot;headerlink&quot; title=&quot;什么是通货膨胀？&quot;&gt;&lt;/a&gt;什么是通货膨胀？&lt;/h3&gt;&lt;p&gt;简单地说，就是人们手里的资金贬值，物价上涨。&lt;/p&gt;
&lt;img src=&quot;/2019/01/
      
    
    </summary>
    
      <category term="Finance" scheme="https://sulangsss.github.io/categories/Finance/"/>
    
    
      <category term="Finance" scheme="https://sulangsss.github.io/tags/Finance/"/>
    
      <category term="金融" scheme="https://sulangsss.github.io/tags/%E9%87%91%E8%9E%8D/"/>
    
      <category term="金融思维" scheme="https://sulangsss.github.io/tags/%E9%87%91%E8%9E%8D%E6%80%9D%E7%BB%B4/"/>
    
      <category term="通货膨胀" scheme="https://sulangsss.github.io/tags/%E9%80%9A%E8%B4%A7%E8%86%A8%E8%83%80/"/>
    
  </entry>
  
  <entry>
    <title>Leverage 杠杆 - 是天使还是魔鬼</title>
    <link href="https://sulangsss.github.io/2019/01/27/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E8%A1%8C%E4%B8%9A/%E9%87%91%E8%9E%8D/%E9%87%91%E8%9E%8D%E6%80%9D%E7%BB%B4/1.1%20Leverage/"/>
    <id>https://sulangsss.github.io/2019/01/27/读书笔记/行业/金融/金融思维/1.1 Leverage/</id>
    <published>2019-01-27T15:24:07.000Z</published>
    <updated>2019-02-02T03:27:07.835Z</updated>
    
    <content type="html"><![CDATA[<h3 id="“杠杆”是什么？"><a href="#“杠杆”是什么？" class="headerlink" title="“杠杆”是什么？"></a>“杠杆”是什么？</h3><img src="/2019/01/27/读书笔记/行业/金融/金融思维/1.1%20Leverage/leverage-1.png"><p>杠杆的本质就是负债。通过向个人或机构借钱，用少量的本金来撬动更大的资产。</p><img src="/2019/01/27/读书笔记/行业/金融/金融思维/1.1%20Leverage/leverage-2.png"><img src="/2019/01/27/读书笔记/行业/金融/金融思维/1.1%20Leverage/leverage-3.png"><hr><h3 id="正确看待杠杆"><a href="#正确看待杠杆" class="headerlink" title="正确看待杠杆"></a>正确看待杠杆</h3><img src="/2019/01/27/读书笔记/行业/金融/金融思维/1.1%20Leverage/leverage-4.png"><p>简单来看，只要借钱的成本低于创造的价值，就是一笔划算的负债，就是一个好的金融杠杆。</p><hr><h3 id="为什么房贷是最便宜的杠杆之一"><a href="#为什么房贷是最便宜的杠杆之一" class="headerlink" title="为什么房贷是最便宜的杠杆之一"></a>为什么房贷是最便宜的杠杆之一</h3><p>贷款买房，意味着给自己的资产加杠杆，撬动更多的钱来衍生更多的财务性收入。</p><img src="/2019/01/27/读书笔记/行业/金融/金融思维/1.1%20Leverage/leverage-5.png"><img src="/2019/01/27/读书笔记/行业/金融/金融思维/1.1%20Leverage/leverage-6.png"><img src="/2019/01/27/读书笔记/行业/金融/金融思维/1.1%20Leverage/leverage-7.png"><hr><h3 id="为什么炒股一定不要用杠杆"><a href="#为什么炒股一定不要用杠杆" class="headerlink" title="为什么炒股一定不要用杠杆"></a>为什么炒股一定不要用杠杆</h3><img src="/2019/01/27/读书笔记/行业/金融/金融思维/1.1%20Leverage/leverage-8.png"><p>收益比例的增长了，随之而来的，风险也成比例的增长。</p><ul><li>股市中使用杠杆会放大我们的收益波动。</li><li>杠杆本身也是有成本的，如贷款的手续费和服务费。</li><li>从历史经验和数据来看，股市杠杆有非常多的血泪教训。</li></ul><blockquote><p>巴菲特也非常不赞成在股市投资中使用财务杠杆，他认为借钱炒股是不可理喻的事情。</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;“杠杆”是什么？&quot;&gt;&lt;a href=&quot;#“杠杆”是什么？&quot; class=&quot;headerlink&quot; title=&quot;“杠杆”是什么？&quot;&gt;&lt;/a&gt;“杠杆”是什么？&lt;/h3&gt;&lt;img src=&quot;/2019/01/27/读书笔记/行业/金融/金融思维/1.1%20Lever
      
    
    </summary>
    
      <category term="Finance" scheme="https://sulangsss.github.io/categories/Finance/"/>
    
    
      <category term="Finance" scheme="https://sulangsss.github.io/tags/Finance/"/>
    
      <category term="金融" scheme="https://sulangsss.github.io/tags/%E9%87%91%E8%9E%8D/"/>
    
      <category term="金融思维" scheme="https://sulangsss.github.io/tags/%E9%87%91%E8%9E%8D%E6%80%9D%E7%BB%B4/"/>
    
      <category term="杠杆" scheme="https://sulangsss.github.io/tags/%E6%9D%A0%E6%9D%86/"/>
    
  </entry>
  
  <entry>
    <title>Vim Configuration</title>
    <link href="https://sulangsss.github.io/2019/01/25/Vim/Configuration/"/>
    <id>https://sulangsss.github.io/2019/01/25/Vim/Configuration/</id>
    <published>2019-01-25T13:01:22.000Z</published>
    <updated>2019-01-26T16:00:48.886Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h3><h4 id="Mac-OS"><a href="#Mac-OS" class="headerlink" title="Mac OS"></a>Mac OS</h4><p>方案一：</p><ul><li>brew install vim –with-lua –with-override-system-vi</li><li>GUI：brew install macvim –with-lua –with-override-system-vim</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">==&gt; lua</span><br><span class="line">You may also want luarocks:</span><br><span class="line">  brew install luarocks</span><br><span class="line">==&gt; perl</span><br><span class="line">By default non-brewed cpan modules are installed to the Cellar. If you wish</span><br><span class="line"><span class="keyword">for</span> your modules to persist across updates we recommend using `<span class="built_in">local</span>::lib`.</span><br><span class="line"></span><br><span class="line">You can <span class="built_in">set</span> that up like this:</span><br><span class="line">  PERL_MM_OPT=<span class="string">"INSTALL_BASE=<span class="variable">$HOME</span>/perl5"</span> cpan <span class="built_in">local</span>::lib</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">'eval "$(perl -I$HOME/perl5/lib/perl5 -Mlocal::lib=$HOME/perl5)"'</span> &gt;&gt; ~/.zshrc</span><br><span class="line">==&gt; readline</span><br><span class="line">readline is keg-only, <span class="built_in">which</span> means it was not symlinked into /usr/<span class="built_in">local</span>,</span><br><span class="line">because macOS provides the BSD libedit library, <span class="built_in">which</span> shadows libreadline.</span><br><span class="line">In order to prevent conflicts when programs look <span class="keyword">for</span> libreadline we are</span><br><span class="line">defaulting this GNU Readline installation to keg-only.</span><br><span class="line"></span><br><span class="line">For compilers to find readline you may need to <span class="built_in">set</span>:</span><br><span class="line">  <span class="built_in">export</span> LDFLAGS=<span class="string">"-L/usr/local/opt/readline/lib"</span></span><br><span class="line">  <span class="built_in">export</span> CPPFLAGS=<span class="string">"-I/usr/local/opt/readline/include"</span></span><br><span class="line"></span><br><span class="line">==&gt; sqlite</span><br><span class="line">sqlite is keg-only, <span class="built_in">which</span> means it was not symlinked into /usr/<span class="built_in">local</span>,</span><br><span class="line">because macOS provides an older sqlite3.</span><br><span class="line"></span><br><span class="line">If you need to have sqlite first <span class="keyword">in</span> your PATH run:</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">'export PATH="/usr/local/opt/sqlite/bin:$PATH"'</span> &gt;&gt; ~/.zshrc</span><br><span class="line"></span><br><span class="line">For compilers to find sqlite you may need to <span class="built_in">set</span>:</span><br><span class="line">  <span class="built_in">export</span> LDFLAGS=<span class="string">"-L/usr/local/opt/sqlite/lib"</span></span><br><span class="line">  <span class="built_in">export</span> CPPFLAGS=<span class="string">"-I/usr/local/opt/sqlite/include"</span></span><br><span class="line"></span><br><span class="line">==&gt; python</span><br><span class="line">Python has been installed as</span><br><span class="line">  /usr/<span class="built_in">local</span>/bin/python3</span><br><span class="line"></span><br><span class="line">Unversioned symlinks `python`, `python-config`, `pip` etc. pointing to</span><br><span class="line">`python3`, `python3-config`, `pip3` etc., respectively, have been installed into</span><br><span class="line">  /usr/<span class="built_in">local</span>/opt/python/libexec/bin</span><br><span class="line"></span><br><span class="line">If you need Homebrew<span class="string">'s Python 2.7 run</span></span><br><span class="line"><span class="string">  brew install python@2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You can install Python packages with</span></span><br><span class="line"><span class="string">  pip3 install &lt;package&gt;</span></span><br><span class="line"><span class="string">They will install into the site-package directory</span></span><br><span class="line"><span class="string">  /usr/local/lib/python3.7/site-packages</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">See: https://docs.brew.sh/Homebrew-and-Python</span></span><br><span class="line"><span class="string">==&gt; ruby</span></span><br><span class="line"><span class="string">By default, binaries installed by gem will be placed into:</span></span><br><span class="line"><span class="string">  /usr/local/lib/ruby/gems/2.6.0/bin</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You may want to add this to your PATH.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ruby is keg-only, which means it was not symlinked into /usr/local,</span></span><br><span class="line"><span class="string">because macOS already provides this software and installing another version in</span></span><br><span class="line"><span class="string">parallel can cause all kinds of trouble.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">If you need to have ruby first in your PATH run:</span></span><br><span class="line"><span class="string">  echo '</span><span class="built_in">export</span> PATH=<span class="string">"/usr/local/opt/ruby/bin:<span class="variable">$PATH</span>"</span><span class="string">' &gt;&gt; ~/.zshrc</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">For compilers to find ruby you may need to set:</span></span><br><span class="line"><span class="string">  export LDFLAGS="-L/usr/local/opt/ruby/lib"</span></span><br><span class="line"><span class="string">  export CPPFLAGS="-I/usr/local/opt/ruby/include"</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Install&quot;&gt;&lt;a href=&quot;#Install&quot; class=&quot;headerlink&quot; title=&quot;Install&quot;&gt;&lt;/a&gt;Install&lt;/h3&gt;&lt;h4 id=&quot;Mac-OS&quot;&gt;&lt;a href=&quot;#Mac-OS&quot; class=&quot;headerlink&quot; 
      
    
    </summary>
    
      <category term="Vim" scheme="https://sulangsss.github.io/categories/Vim/"/>
    
    
      <category term="Configuration" scheme="https://sulangsss.github.io/tags/Configuration/"/>
    
      <category term="Vim" scheme="https://sulangsss.github.io/tags/Vim/"/>
    
  </entry>
  
  <entry>
    <title>重放攻击 Replay Attack</title>
    <link href="https://sulangsss.github.io/2019/01/25/Security/Web/Replay-Attack/"/>
    <id>https://sulangsss.github.io/2019/01/25/Security/Web/Replay-Attack/</id>
    <published>2019-01-25T05:05:06.000Z</published>
    <updated>2019-01-25T13:27:54.748Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><img src="/2019/01/25/Security/Web/Replay-Attack/Replay_attack_on_hash.svg.png"><p>重放攻击(Replay attack，或重送攻击)是一种网络攻击，指攻击者发送一个目的主机已接收过的包，来达到欺骗系统的目的，主要用于身份认证过程，破坏认证的正确性。</p><p>这种攻击会不断恶意或欺诈性地重复一个有效的数据传输，重放攻击可以由发起者，也可以由拦截并重发该数据的敌方进行。攻击者利用网络监听或者其他方式盗取认证凭据，之后再把它重新发给认证服务器。从这个解释上理解，加密可以有效防止会话劫持，但是却防止不了重放攻击。重放攻击任何网络通讯过程中都可能发生。</p><hr><h3 id="How-to-defend-against-it"><a href="#How-to-defend-against-it" class="headerlink" title="How to defend against it"></a>How to defend against it</h3><h4 id="时间戳"><a href="#时间戳" class="headerlink" title="时间戳"></a>时间戳</h4><p>首先我们认为一次HTTP请求从发出到到达服务器的时间是不会超过60s的，当你发送一个请求时必须携带一个时间戳timestamp。假设值为10，当请求到达服务器之后，服务器会取出当前时间，假设为t2=80,很明显t2 - timestamp &gt; 60s，那么服务器就认为请求不合法。</p><blockquote><p>发送的数据必须带上sign(比如，MD5签名生成的)，避免数据被篡改。</p></blockquote><p>存在的问题是：如果黑客在60s内发起攻击，那么我们就束手无策了。那是不是缩小时间范围就可以解决了？</p><h4 id="时间戳-随机数nonce"><a href="#时间戳-随机数nonce" class="headerlink" title="时间戳 + 随机数nonce"></a>时间戳 + 随机数nonce</h4><p>为了避免上面时间戳的问题，可以加入一个随机数nonce，每次成功请求，服务器会保存当前成功请求的随机数nonce，比如存放在redis和数据库中，当请求再次进到服务器，先验证时间戳是否有效，如果有效，再判断携带的随机数nonce是否在缓存或者数据库中已经存在，如果存在，则认为请求非法。</p><p>但你会发现，如果系统请求非常多，这个存放nonce的redis或者数据库势必会越来越大，因此，我们只需要保存服务器当前时间60秒内的nonce值即可。</p><blockquote><p>前提条件：保证随机数nonce绝对唯一。</p></blockquote><h4 id="序号"><a href="#序号" class="headerlink" title="序号"></a>序号</h4><p>通信双方必须事先协商一个初始序列号，并协商递增方法。然后双方通过消息中的序列号来判断消息的新鲜性。例如，如果nonce=1000已经请求过了，那么nonce&lt;1000的请求都是无效请求。</p><blockquote><p>A single account may have multiple API keys provisioned. In this document, we’ll refer to these as “sessions”. All orders will be recorded with the session that created them. The nonce associated with a request needs to be increasing with respect to the session that the nonce is used on.<br>This allows multithreaded or distributed trading systems to place orders independently of each other, without needing to synchronize clocks to avoid race conditions.<br>In addition, some operations (such as Cancel All Session Orders) act on the orders associated with a specific session.</p></blockquote><h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> request = <span class="built_in">require</span>(<span class="string">'request'</span>)</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> apiKey = <span class="string">'&lt;Your API key here&gt;'</span></span><br><span class="line"><span class="keyword">const</span> apiSecret = <span class="string">'&lt;Your API secret here&gt;'</span></span><br><span class="line"><span class="keyword">const</span> baseUrl = <span class="string">'https://api.xxx.com'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> url = <span class="string">'/v1/account'</span></span><br><span class="line"><span class="keyword">const</span> nonce = <span class="built_in">Date</span>.now().toString()</span><br><span class="line"><span class="keyword">const</span> completeURL = baseUrl + url</span><br><span class="line"><span class="keyword">const</span> body = &#123;</span><br><span class="line">  request: url,</span><br><span class="line">  nonce</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> payload = <span class="keyword">new</span> Buffer(<span class="built_in">JSON</span>.stringify(body))</span><br><span class="line">.toString(<span class="string">'base64'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> signature = crypto</span><br><span class="line">  .createHmac(<span class="string">'sha384'</span>, apiSecret)</span><br><span class="line">  .update(payload)</span><br><span class="line">  .digest(<span class="string">'hex'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  url: completeURL,</span><br><span class="line">  headers: &#123;</span><br><span class="line">    <span class="string">'X-APIKEY'</span>: apiKey,</span><br><span class="line">    <span class="string">'X-PAYLOAD'</span>: payload,</span><br><span class="line">    <span class="string">'X-SIGNATURE'</span>: signature</span><br><span class="line">  &#125;,</span><br><span class="line">  body: <span class="built_in">JSON</span>.stringify(body)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> request.post(</span><br><span class="line">  options,</span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params">error, response, body</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'response:'</span>, <span class="built_in">JSON</span>.stringify(body, <span class="number">0</span>, <span class="number">2</span>))</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><hr><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><blockquote><p><a href="https://blog.csdn.net/heluan123132/article/details/74375304" target="_blank" rel="noopener">https://blog.csdn.net/heluan123132/article/details/74375304</a><br><a href="https://juejin.im/post/5ad43b86f265da239236cedc" target="_blank" rel="noopener">https://juejin.im/post/5ad43b86f265da239236cedc</a><br><a href="https://docs.gemini.com/rest-api/#private-api-invocation" target="_blank" rel="noopener">https://docs.gemini.com/rest-api/#private-api-invocation</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Introduction&quot;&gt;&lt;a href=&quot;#Introduction&quot; class=&quot;headerlink&quot; title=&quot;Introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h3&gt;&lt;img src=&quot;/2019/01/25/Security/We
      
    
    </summary>
    
      <category term="Security" scheme="https://sulangsss.github.io/categories/Security/"/>
    
      <category term="Web" scheme="https://sulangsss.github.io/categories/Security/Web/"/>
    
    
      <category term="Security" scheme="https://sulangsss.github.io/tags/Security/"/>
    
      <category term="Replay Attach" scheme="https://sulangsss.github.io/tags/Replay-Attach/"/>
    
      <category term="Web" scheme="https://sulangsss.github.io/tags/Web/"/>
    
      <category term="重放共计" scheme="https://sulangsss.github.io/tags/%E9%87%8D%E6%94%BE%E5%85%B1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>优雅处理异常</title>
    <link href="https://sulangsss.github.io/2019/01/20/SpringBoot/Exception/HandleException/"/>
    <id>https://sulangsss.github.io/2019/01/20/SpringBoot/Exception/HandleException/</id>
    <published>2019-01-20T15:13:06.000Z</published>
    <updated>2019-02-13T03:45:04.517Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>我们开发的业务系统,或者是产品,常常面临着这样的问题：</p><ul><li>系统运行出错,但是完全不知道错误发生的位置；</li><li>我们找到了错误的位置,但是完全不知道是因为什么；</li><li>系统明明出了错误,但是就是看不到错误堆栈信息。</li></ul><h4 id="什么时候需要自定异常？"><a href="#什么时候需要自定异常？" class="headerlink" title="什么时候需要自定异常？"></a>什么时候需要自定异常？</h4><p>经常看到一些项目，在全局定义一个 AppException，然后所有地方都只抛出这个异常，并且把捕获的异常case到这个AppException中。</p><p>这样做会有如下问题：</p><ul><li>浪费log日志存储空间，并且栈顶并不是最接近发生异常的代码位置；</li><li>只有一种异常类，无法精准区分开异常类型；</li><li>异常类后期难以修改以增加其携带的信息。</li></ul><h4 id="什么情况需要手动处理异常？"><a href="#什么情况需要手动处理异常？" class="headerlink" title="什么情况需要手动处理异常？"></a>什么情况需要手动处理异常？</h4><ul><li>你有能力处理异常，并且你知道如何处理；</li><li>你有责任处理异常。</li></ul><hr><h3 id="如何优雅地处理异常"><a href="#如何优雅地处理异常" class="headerlink" title="如何优雅地处理异常"></a>如何优雅地处理异常</h3><p>首先，有一点我们要清楚：MVC设计模式告诉我们，Controller是用来接收页面参数，并且调用逻辑处理，最后组织页面响应的地方。不建议在Controller进行逻辑处理，Controller只应该负责用户API入口和响应的处理。</p><blockquote><p>思考一下如果有一天Service的代码打包成jar放到另一个平台，没有controller了，该怎么办？</p></blockquote><h4 id="定义Service异常"><a href="#定义Service异常" class="headerlink" title="定义Service异常"></a>定义Service异常</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseExp</span></span>(<span class="keyword">val</span> code: <span class="built_in">Int</span>, error: String) : RuntimeException(error)&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceExp</span></span>(code: <span class="built_in">Int</span>, message: String) : BaseExp(code, message) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个异常继承自RuntimeException，并且包含一个接受一个错误原因的构造器，这样Controller层也不需要知道异常，只要全局捕获到ServiceExp做统一的处理即可。</p><p>这无论是在Struct1、2时代，还是SpringMVC中，甚至Servlet年代，都是极为容易的。</p><p>此外，异常不能有无参构造函数，因为绝对不允许你抛出一个逻辑处理异常，但是不指明原因。</p><hr><h4 id="Controller处理举例"><a href="#Controller处理举例" class="headerlink" title="Controller处理举例"></a>Controller处理举例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 修改用户信息</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> userID 用户ID</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> user 修改用户信息表单数据</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@PutMapping</span>(<span class="string">"&#123;userID&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> JSONResult <span class="title">updateUser</span><span class="params">(@PathVariable(<span class="string">"userID"</span>)</span> Integer userID, @RequestBody UpdateUserForm userForm) </span>&#123;</span><br><span class="line">    User user = <span class="keyword">new</span> User(); <span class="comment">//准备业务逻辑层使用的领域模型</span></span><br><span class="line">    BeanUtils.copyProperties(userForm, user); <span class="comment">//拷贝要修改的值</span></span><br><span class="line">    user.setUserId(userID); <span class="comment">//设置主键到用户数据中</span></span><br><span class="line">    userService.updateUser(user); <span class="comment">//调用更新业务逻辑</span></span><br><span class="line">    JSONResult json = <span class="keyword">new</span> JSONResult(); <span class="comment">//准备要响应的数据</span></span><br><span class="line">    json.put(<span class="string">"user"</span>, user); <span class="comment">//把修改后的用户数据还给页面</span></span><br><span class="line">    <span class="keyword">return</span> json;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>数据校验一般分为两部分：</strong></p><ul><li>有效性：比如用户所在岗位，是否属于数据库有记录的岗位ID，如果不存在，无效。</li><li>合法性：比如用户名只允许输入最多12个字符，用户提交了20个字符，不合法。建议使用校验框架，比如JSR303</li></ul><p><strong>假如出现以下问题，如何通知用户？</strong></p><ul><li>要修改的用户ID不存在；</li><li>用户被锁定，不允许修改；</li><li>乐观锁机制发现用户已经被被人修改过等等。</li></ul><p>常见的处理方式有：</p><ol><li>在Controller调用UserService的checkUserExist()方法；</li><li>在Controller直接书写业务逻辑；</li><li>在Service响应一个状态码机制，比如1 2 3表示错误信息，0表示没有任何错误。</li></ol><p>根据MVC设计模式来说，第一种和第二种都不考虑。而第三种似乎是一种可选的方式，可是如此一来，用户保存逻辑变了，比如增加一个情况，不允许修改已经离职的用户，那么我们还需要修改Controller的代码，代码量增加，维护成本增高，并且还耦合了Service，不符合MVC设计模式。</p><hr><h4 id="Service处理举例"><a href="#Service处理举例" class="headerlink" title="Service处理举例"></a>Service处理举例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 修改用户信息</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> user 要修改的用户数据</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">    User userOrig = userDao.getUserById(user.getUserID());</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == userOrig) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ServiceExp(<span class="string">"用户不存在"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (userOrig.isLocked()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ServiceExp(<span class="string">"用户被锁定,不允许修改"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!user.getVersion().equals(userOrig.getVersion())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ServiceExp(<span class="string">"用户已经被别人修改过,请刷新重试"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TODO 保存用户数据  ... </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>只要我们检查到不允许保存的对象，我们就可以直接throw一个新的异常，异常机制会帮助我们中断代码执行。</p><p>Service上层处理异常的方式有：</p><ol><li>在Controller使用try-catch进行处理；</li><li>直接把异常抛给上层框架统一处理。</li></ol><p>第一种方式直接pass掉，注意我们抛出的ServiceExp，它仅仅逻辑处理异常，并且我们的方法前面也没有声明throws ServiceExp，这表示它是一个非受查异常。</p><p><strong>Q：为什么不定义成受查异常？</strong> 如果是一个受查异常，那么意味着Controller必须要处理你的异常。并且如果有一天你的业务逻辑变了，可能多一种检查项，就需要增加一个异常。反之需要删除一个异常，那么你的方法签名也需要改变，Controller也随之要改变，这又变成了紧耦合。</p><p><strong>Q：可以为每一种检查项定义一个异常吗？</strong>可以，但是那样显得太多余了。因为业务逻辑处理失败的时候，根据我们需求，我们只需要通知用户失败的原因(通常应该是一段字符串)，以及服务器受理失败的一个状态码，这样这需要一个包含原因属性的异常即可满足我们需求。</p><hr><h4 id="ControllerAdvice处理举例"><a href="#ControllerAdvice处理举例" class="headerlink" title="ControllerAdvice处理举例"></a>ControllerAdvice处理举例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span>(basePackages = &#123; <span class="string">"com.xxx.bussiness.xxx"</span> &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ModuleControllerAdvice</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(ModuleControllerAdvice.class);</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger SERVICE_LOGGER = LoggerFactory.getLogger(ServiceExp.class);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 业务受理失败</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@ResponseBody</span></span><br><span class="line">  <span class="meta">@ResponseStatus</span>(HttpStatus.INTERNAL_SERVER_ERROR)</span><br><span class="line">  <span class="meta">@ExceptionHandler</span>(ServiceExp.class)</span><br><span class="line">  <span class="function"><span class="keyword">private</span> JSONResult <span class="title">handleServiceException</span><span class="params">(ServiceExp exception)</span> </span>&#123;</span><br><span class="line">    String message = <span class="string">"业务受理失败,原因:"</span> + exception.getLocalizedMessage();</span><br><span class="line">    SERVICE_LOGGER.info(message);</span><br><span class="line">    JSONResult json = <span class="keyword">new</span> JSONResult();</span><br><span class="line">    json.serCode(<span class="number">500001</span>);</span><br><span class="line">    json.setMessage(message); </span><br><span class="line">    <span class="keyword">return</span> json;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意一点，在这个类中，我们定义了2个log对象，分别指向ServiceExp.class 和 ControllerAdvice.class，处理ServiceExp的时候使用了info级别的日志输出。</p><ul><li>ServiceExp一定要和其他的代码错误分离，不应该混为一谈。</li><li>ServiceExp并不一定要记录日志，我们应该提供独立的log对象，方便开关。</li></ul><hr><h3 id="异常分类建议"><a href="#异常分类建议" class="headerlink" title="异常分类建议"></a>异常分类建议</h3><ul><li>逻辑异常类：用于描述业务无法按照预期的情况处理下去，属于用户制造的意外。</li><li>代码错误类：这类异常用于描述开发的代码错误，例如NPE、ILLARG等都属于程序员制造的BUG。</li><li>专用异常类：多用于特定业务场景，用于描述指定作业出现意外情况无法预先处理。</li></ul><p>各类异常必须要有单独的日志记录，或者分级，便于日志管理。比如，有的时候仅仅想给三方运维看到逻辑异常。</p><h4 id="Counter-Example"><a href="#Counter-Example" class="headerlink" title="Counter-Example"></a>Counter-Example</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 处理业务消息</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> message 要处理的消息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processMessage</span><span class="params">(Message&lt;String&gt; message)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">// 处理消息验证</span></span><br><span class="line">        <span class="comment">// 处理消息解析</span></span><br><span class="line">        <span class="comment">// 处理消息入库</span></span><br><span class="line">    &#125;<span class="keyword">catch</span>(ValidateException e )&#123;</span><br><span class="line">        <span class="comment">// 验证失败</span></span><br><span class="line">    &#125;<span class="keyword">catch</span>(ParseException e )&#123;</span><br><span class="line">        <span class="comment">// 解析失败</span></span><br><span class="line">    &#125;<span class="keyword">catch</span>(PersistException e )&#123;</span><br><span class="line">        <span class="comment">// 入库失败</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改后的代码，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 处理业务消息</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> message 要处理的消息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processMessage</span><span class="params">(Message&lt;String&gt; message)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 处理消息验证</span></span><br><span class="line">    <span class="keyword">if</span>(!message.isValud())&#123;</span><br><span class="line">        MessageLogService.log(<span class="string">"消息校验失败"</span> + message.errors())</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 处理消息解析</span></span><br><span class="line">    <span class="keyword">if</span>(!message.parse())&#123;</span><br><span class="line">        MessageLogService.log(<span class="string">"消息解析失败"</span> + message.errors())</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TODO ....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><blockquote><p><a href="https://mp.weixin.qq.com/s/GXSZ-3w3Px43fA3XEuyWxw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/GXSZ-3w3Px43fA3XEuyWxw</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Introduction&quot;&gt;&lt;a href=&quot;#Introduction&quot; class=&quot;headerlink&quot; title=&quot;Introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h3&gt;&lt;p&gt;我们开发的业务系统,或者是产品,常常面临着这样的问题：&lt;/p
      
    
    </summary>
    
      <category term="Spring Boot" scheme="https://sulangsss.github.io/categories/Spring-Boot/"/>
    
      <category term="Exception" scheme="https://sulangsss.github.io/categories/Spring-Boot/Exception/"/>
    
    
      <category term="Exception" scheme="https://sulangsss.github.io/tags/Exception/"/>
    
      <category term="Spring Boot" scheme="https://sulangsss.github.io/tags/Spring-Boot/"/>
    
      <category term="优雅处理异常" scheme="https://sulangsss.github.io/tags/%E4%BC%98%E9%9B%85%E5%A4%84%E7%90%86%E5%BC%82%E5%B8%B8/"/>
    
  </entry>
  
</feed>
